<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모클 성적 조회 시스템 (AI 분석 포함) - 고3</title>
    <!-- Google tag (gtag.js) --> 
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KSGCB6G9HJ"></script> 
    <script> 
    window.dataLayer = window.dataLayer || []; 
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date()); 
    gtag('config', 'G-KSGCB6G9HJ'); 
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* AI 분석 관련 스타일 */
        .ai-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }
        
        .ai-analysis::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="30" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
            pointer-events: none;
        }
        
        .ai-analysis-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .ai-icon {
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            backdrop-filter: blur(10px);
        }
        
        .ai-analysis h3 {
            font-size: 1.5em;
            margin: 0;
        }
        
        .ai-content {
            position: relative;
            z-index: 1;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .analysis-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .analysis-card h4 {
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .trend-up { color: #4ade80; }
        .trend-down { color: #f87171; }
        .trend-stable { color: #fbbf24; }
        
        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .grade-excellent { background: #ef4444; }
        .grade-good { background: #f97316; }
        .grade-average { background: #eab308; }
        .grade-needs-improvement { background: #06b6d4; }
        .grade-poor { background: #8b5cf6; }
        
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            animation: pulse 1.4s infinite ease-in-out;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .ai-recommendations {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #10b981;
        }
        
        .ai-recommendations h4 {
            margin-bottom: 15px;
            color: #10b981;
        }
        
        .recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
        }
        
        .recommendation-priority {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        /* 새로운 구체적 등급 상승 전략 스타일 */
        .grade-strategy {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4ade80;
        }
        
        .grade-strategy h4 {
            margin-bottom: 15px;
            color: #4ade80;
            font-size: 1.1em;
        }
        
        .recent-tests-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }
        
        .recent-test-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .recent-test-name {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .recent-test-grade {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .recent-test-score {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .target-analysis {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .target-grade {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .target-possibility {
            font-size: 0.85em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .possibility-high { background: #10b981; color: white; }
        .possibility-medium { background: #f59e0b; color: white; }
        .possibility-low { background: #ef4444; color: white; }
        
        .subject-strategy-list {
            margin: 15px 0;
        }
        
        .subject-strategy-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .subject-strategy-left {
            flex: 1;
        }
        
        .subject-strategy-right {
            text-align: right;
        }
        
        .subject-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .subject-detail {
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .points-gain {
            font-size: 1.1em;
            font-weight: bold;
            color: #4ade80;
        }
        
        .total-strategy {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .total-points {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        /* 기존 스타일들 유지... */
        .admin-check {
            background: #fff3cd;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #ffc107;
        }
        
        .admin-check h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .admin-check p {
            color: #856404;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .admin-password {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 1em;
            margin: 10px 0;
        }
        
        .admin-btn {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 5px;
        }
        
        .admin-btn:hover {
            background: #e0a800;
        }
        
        .setup-section {
            background: #e8f2ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .setup-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .setup-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .setup-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            margin: 10px 0;
        }
        
        .setup-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 5px;
        }
        
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f9f9f9;
            transition: all 0.3s;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f2ff;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .progress {
            margin: 20px 0;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .data-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-label {
            color: #666;
            margin-top: 5px;
        }
        
        .search-section {
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
        }
        
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .instructions {
            background: #e8f2ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .instructions h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .instructions p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .student-info {
            background: #e8f2ff;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #667eea;
        }
        
        .student-info h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.6em;
        }
        
        .summary-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            overflow-x: auto;
        }
        
        .summary-table h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .grade-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        .grade-table th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .grade-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .grade-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .test-name {
            font-weight: bold;
            color: #667eea;
            text-align: left !important;
            min-width: 80px;
        }
        
        .grade-cell {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .score-cell {
            font-weight: bold;
            color: #333;
        }
        
        .absent-cell {
            color: #999;
            font-style: italic;
        }
        
        .source-cell {
            font-size: 0.8em;
            color: #666;
        }
        
        .grade-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
        }
        
        .grade-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .grade-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .grade-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .grade-summary-item {
            text-align: center;
        }
        
        .grade-summary-value {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .grade-summary-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .grade-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        
        .grade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .grade-label {
            color: #555;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .grade-value {
            font-weight: bold;
            color: #333;
        }
        
        .grade-1 { color: #e74c3c; }
        .grade-2 { color: #f39c12; }
        .grade-3 { color: #f1c40f; }
        .grade-4 { color: #2ecc71; }
        .grade-5 { color: #3498db; }
        .grade-6 { color: #9b59b6; }
        
        .no-results, .no-data {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-top: 40px;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        /* 고3 전용 선택과목 표시 스타일 */
        .subject-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .subject-type.화법과작문, .subject-type.화법과_작문 {
                background: #10b981;
                color: white;
            }
            
            .subject-type.언어와매체, .subject-type.언어와_매체 {
                background: #3b82f6;
                color: white;
            }
        
        @media (max-width: 768px) {
            /* 뷰포트 단위로 전체 크기 자동 조정 */
            .container {
                padding: 4vw; /* 화면 너비의 4% */
                font-size: 3.5vw; /* 기본 폰트를 화면 너비의 3.5%로 */
            }
            
            /* 제목들 뷰포트 단위 적용 */
            .header h1 {
                font-size: 7vw; /* 화면 너비의 7% */
            }
            
            .header p {
                font-size: 4vw; /* 화면 너비의 4% */
            }
            
            /* 탭 버튼 크기 조정 */
            .tab {
                font-size: 3.5vw;
                padding: 3vw 5vw;
            }
            
            /* 검색 입력창과 버튼 */
            .search-input {
                font-size: 4vw;
                padding: 3vw;
            }
            
            .search-btn {
                font-size: 3.5vw;
                padding: 3vw 5vw;
            }
            
            /* AI 분석 섹션 */
            .ai-analysis h3 {
                font-size: 4.5vw;
            }
            
            .ai-analysis h4 {
                font-size: 3.5vw;
            }
            
            /* 테이블 */
            .grade-table {
                font-size: 2.8vw;
            }
            
            /* 테이블 컨테이너 오버플로우 해결 */
            .summary-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
            }
            
            .grade-table {
                min-width: 100%;
                white-space: nowrap; /* 텍스트 줄바꿈 방지 */
            }
            
            .grade-table th,
            .grade-table td {
                min-width: 60px; /* 최소 너비 설정 */
                padding: 2vw 1vw; /* 패딩을 뷰포트 단위로 */
                font-size: 2.5vw; /* 조금 더 작게 */
            }
            
            .test-name {
                min-width: 80px !important; /* 시험명 칸은 조금 더 넓게 */
            }
            
            /* 기존 레이아웃 조정들 */
            .search-box {
                flex-direction: column;
            }
            
            .grade-cards {
                grid-template-columns: 1fr;
            }
            
            .tab-container {
                flex-direction: column;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .recent-tests-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 과목별 성취도 테이블 개선 */
            .summary-table div[style*="overflow-x: auto"] {
                padding-bottom: 10px; /* 스크롤바 여백 */
            }
            
            .summary-table table[style*="min-width: 1200px"] {
                min-width: 800px !important; /* 모바일에서는 800px로 축소 */
            }
            
            /* 대시보드 모바일 최적화 */
            .dashboard-grid {
                grid-template-columns: 1fr !important; /* 한 열로 변경 */
                gap: 15px;
            }
            
            .dashboard-card {
                padding: 15px; /* 패딩 축소 */
                font-size: 3.2vw; /* 뷰포트 단위 적용 */
            }
            
            .dashboard-card h3 {
                font-size: 4vw;
                margin-bottom: 12px;
            }
            
            .stat-item {
                padding: 2vw 0;
                font-size: 3vw;
            }
            
            .stat-label {
                font-size: 3vw;
            }
            
            .stat-value {
                font-size: 3.2vw;
            }
            
            /* D-day 카운터 모바일 최적화 */
            .dday-counter {
                padding: 15px;
                margin: 15px 0;
            }
            
            .dday-number {
                font-size: 2.5em; /* 3em에서 축소 */
            }
            
            .dday-text {
                font-size: 4vw;
            }
            
            /* 뱃지 컨테이너 모바일 최적화 */
            .badge-container {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* 140px에서 120px로 축소 */
                gap: 6px;
            }
            
            .achievement-badge {
                padding: 6px 8px; /* 8px 10px에서 축소 */
                font-size: 2.8vw; /* 0.85em에서 뷰포트 단위로 */
                min-height: 32px; /* 36px에서 축소 */
            }
            
            .badge-summary {
                font-size: 3vw;
                padding: 8px;
                margin: 12px 0;
            }
            
            /* 차트 컨테이너 모바일 최적화 */
            .chart-container {
                height: 250px; /* 300px에서 축소 */
                margin: 15px 0;
            }
        }

        /* 추가 기능 스타일 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            width: 100% !important;  /* !important 추가 */
        }
        
        .dashboard-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.95em;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }
        
        .stat-positive { color: #10b981; }
        .stat-negative { color: #ef4444; }
        .stat-neutral { color: #6b7280; }
        
        .dday-counter {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .dday-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dday-text {
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        /* 뱃지 컨테이너 */
        .badge-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;  /* !important 추가 */
            gap: 8px;
            margin: 15px 0;
        }
        
        .achievement-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 10px;
            border-radius: 20px;
            font-size: 0.85em !important;  /* !important 추가 */
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            text-align: center;
            min-height: 36px;
            color: white;
        }
        
        /* 뱃지 타입별 색상 */
        .achievement-badge.grade { background: linear-gradient(45deg, #ffd700, #ff8c00); }
        .achievement-badge.score { background: linear-gradient(45deg, #667eea, #764ba2); }
        .achievement-badge.trend { background: linear-gradient(45deg, #ff6b6b, #feca57); }
        .achievement-badge.improvement { background: linear-gradient(45deg, #10b981, #059669); }
        .achievement-badge.attendance { background: linear-gradient(45deg, #8b5cf6, #7c3aed); }
        .achievement-badge.special { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .achievement-badge.stability { background: linear-gradient(45deg, #06b6d4, #0891b2); }
        .achievement-badge.rank { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .achievement-badge.recovery { background: linear-gradient(45deg, #84cc16, #65a30d); }
        .achievement-badge.start { background: linear-gradient(45deg, #ec4899, #db2777); }
        .achievement-badge.milestone { background: linear-gradient(45deg, #f97316, #ea580c); }
        
        .badge-new {
            animation: pulse-badge 2s infinite;
        }

/* 🆕 고급 학습 계획서 스타일 */
.plan-target-setting {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
}

.target-input-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.target-input-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 15px;
}

.target-input-item label {
    display: block;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.9em;
}

.target-input-item input,
.target-input-item select {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 0.95em;
}

.generate-plan-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 15px 35px;
    border-radius: 30px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.generate-plan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

/* 고급 계획서 결과 스타일 */
.advanced-study-plan {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 30px;
    margin-top: 25px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.plan-document-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.plan-document-header h3 {
    font-size: 1.4em;
    margin-bottom: 10px;
    color: rgba(255, 255, 255, 0.95);
}

.student-info-banner {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}

.status-dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.status-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid;
}

.current-status-card {
    border-left-color: #dc3545;
}

.target-status-card {
    border-left-color: #28a745;
}

.status-card h4 {
    margin-bottom: 15px;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 10px;
}

.metric-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px 8px;
}

.metric-value {
    font-size: 1.3em;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.7);
}

.improvement-analysis {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

/* 대시보드 모바일 최적화 */
.dashboard-grid {
    grid-template-columns: 1fr !important;
    gap: 15px;
    width: 100%;
    overflow-x: hidden;
}

.dashboard-card {
    width: 100%;
    min-width: 0;
    overflow-x: hidden;
}

.badge-container {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
    gap: 6px;
}

.achievement-badge {
    font-size: 2.5vw !important;
    padding: 6px 8px;
    min-width: 0;
    word-break: break-word;
}

.improvement-analysis h4 {
    margin-bottom: 15px;
    color: rgba(255,255,255,0.95);
    font-size: 1.2em !important;
}
            
.weak-subject-card {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    border-left: 4px solid;
}

.weak-subject-card.priority-high {
    border-left-color: rgba(220, 53, 69, 0.8);
}

.weak-subject-card.priority-medium {
    border-left-color: rgba(255, 193, 7, 0.8);
}

.weak-subject-card.priority-low {
    border-left-color: rgba(23, 162, 184, 0.8);
}

.subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.subject-name {
    font-size: 1.0em;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.95);
}

.priority-badge {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
}

.priority-high { 
    background: rgba(220, 53, 69, 0.8);
    color: white; 
}
.priority-medium { 
    background: rgba(255, 193, 7, 0.9);
    color: #333; 
}
.priority-low { 
    background: rgba(23, 162, 184, 0.8);
    color: white; 
}

.subject-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 15px;
}

.detail-metric {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 10px;
    text-align: center;
}

.detail-value {
    font-size: 1.1em;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 3px;
}

.detail-label {
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.7);
}

.study-materials {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.material-links {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.material-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 600;
    transition: all 0.3s ease;
}

.material-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    text-decoration: none;
    color: white;
}

.weekly-schedule-advanced {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.schedule-week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    margin-top: 20px;
}

.schedule-day {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
    min-height: 120px;
}

.day-name {
    font-weight: bold;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.study-session {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 6px;
    font-size: 0.8em;
    line-height: 1.2;
}

.session-subject {
    font-weight: bold;
    margin-bottom: 2px;
}

.session-time {
    opacity: 0.8;
}

.motivation-banner {
    background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
    color: #333;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.motivation-banner h4 {
    font-size: 1.4em;
    margin-bottom: 15px;
    color: #333;
}

.motivation-text {
    font-size: 1.1em;
    line-height: 1.6;
    font-weight: 500;
}

.plan-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
}

.action-button {
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1em;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.pdf-download-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

.pdf-download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
}

.edit-plan-btn {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: white;
}

.edit-plan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
}
        
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .badge-summary {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            color: #667eea;
            font-weight: bold;
        }

/* 🆕 학습 계획서 모바일 최적화 추가 */
.target-input-grid {
    grid-template-columns: 1fr !important;
    gap: 10px;
}

.target-input-item {
    padding: 10px;
}

.target-input-item label {
    font-size: 3.2vw;
}

.target-input-item input,
.target-input-item select {
    font-size: 3.5vw;
    padding: 8px;
}

.generate-plan-btn {
    font-size: 3.8vw;
    padding: 12px 25px;
}

.status-dashboard {
    grid-template-columns: 1fr !important;
}

.status-metrics {
    grid-template-columns: repeat(2, 1fr) !important;
}

.subject-details {
    grid-template-columns: repeat(2, 1fr) !important;
}

.schedule-week-grid {
    grid-template-columns: 1fr !important;
}

.material-links {
    flex-direction: column;
}

.material-link {
    font-size: 3vw;
    padding: 10px 15px;
}

.plan-actions {
    flex-direction: column;
    gap: 10px;
}

.action-button {
    font-size: 3.5vw;
    padding: 12px 20px;
}

.weak-subject-card {
    margin-bottom: 20px;
}

.subject-name {
    font-size: 3.8vw;
}

.priority-badge {
    font-size: 2.8vw;
    padding: 4px 8px;
}

.motivation-banner h4 {
    font-size: 4vw;
}

.motivation-text {
    font-size: 3.2vw;
}

/* 학습 계획서 추가 최적화 */
.advanced-study-plan {
    padding: 12px !important;
    margin: 12px 0 !important;
    font-size: 3vw;
    overflow-x: hidden;
}

.plan-document-header h3 {
    font-size: 4.2vw !important;
    line-height: 1.3;
}

.student-info-banner {
    padding: 8px !important;
    font-size: 2.8vw;
}

.improvement-analysis h4 {
    font-size: 3.8vw !important;
    margin-bottom: 8px !important;
}

/* 대시보드 모바일 최적화 */
.dashboard-grid {
    grid-template-columns: 1fr !important;
    gap: 15px;
    width: 100%;
    overflow-x: hidden;
}

.dashboard-card {
    width: 100%;
    min-width: 0;
    overflow-x: hidden;
}

.badge-container {
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)) !important;
    gap: 6px;
}

.achievement-badge {
    font-size: 2.5vw !important;
    padding: 6px 8px;
    min-width: 0;
    word-break: break-word;
}
}  /* ← 이 중괄호가 모바일 미디어 쿼리를 닫는 중괄호입니다! */

.improvement-analysis {  /* ← 여기부터는 PC용 CSS */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.improvement-analysis h4 {
    margin-bottom: 15px;
    color: rgba(255,255,255,0.95);
    font-size: 1.2em;
}

/* PC용 맞춤형 학습 계획서 크기 고정 */
.advanced-study-plan {
    font-size: 14px !important;
}

.plan-document-header h3 {
    font-size: 1.4em !important;
}

.subject-name {
    font-size: 1.0em !important;
}

.motivation-banner h4 {
    font-size: 1.3em !important;
}

.motivation-text {
    font-size: 1.0em !important;
}

.grade-strategy h4 {
    font-size: 1.1em !important;
}
        
.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}
        
        .progress-ring {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        
        .progress-ring-text {
            position: absolute;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        /* 그랜드 마스터 애니메이션 */
        @keyframes grand-master-glow {
            0% { 
                box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
                transform: scale(1);
            }
            100% { 
                box-shadow: 0 12px 35px rgba(255, 215, 0, 0.6);
                transform: scale(1.02);
            }
        }
        
        /* 그랜드 마스터 전용 스타일 */
        .grand-master-message {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            animation: grand-master-glow 2s infinite alternate;
        }

        /* 🚀 여기부터 새로운 CSS 추가! */
/* 새로운 뱃지 스타일 */
.achievement-badge.single-jump { 
    background: linear-gradient(45deg, #16a085, #2ecc71); 
}
.achievement-badge.total-growth { 
    background: linear-gradient(45deg, #27ae60, #2ecc71); 
}
.achievement-badge.subject-master { 
    background: linear-gradient(45deg, #9b59b6, #8e44ad); 
}

/* 뱃지 설명 툴팁 스타일 */
.badge-tooltip {
    position: fixed;                    /* absolute → fixed 변경 */
    background: rgba(0, 0, 0, 0.95);   /* 0.9 → 0.95 변경 (더 진하게) */
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.85em;
    max-width: 250px;
    z-index: 99999;                    /* 1000 → 99999 변경 */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    pointer-events: none;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    line-height: 1.4;
}

.badge-tooltip.visible {
    opacity: 1;
    transform: translateY(0);
}

.badge-tooltip::after {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid rgba(0, 0, 0, 0.9);
}

.achievement-badge {
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.achievement-badge:hover {
    transform: scale(1.05);
    z-index: 10;
}

/* 모바일에서 클릭 피드백 */
.achievement-badge:active {
    transform: scale(0.95);
}

@media (max-width: 768px) {
    .badge-tooltip {
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        max-width: none;
        text-align: center;
    }
    
    .badge-tooltip::after {
        display: none;
    }
}

.badge-new {
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 모클 성적 조회 시스템</h1>
            <p>정동민국어논술학원 • 고3 모의고사 성적 조회 • AI 분석 포함</p>
        </div>
        
        <div class="tab-container">
            <button class="tab active" onclick="switchTab('student')">🔍 성적 조회</button>
            <button class="tab" onclick="switchTab('admin')">⚙️ 관리자</button>
        </div>
        
        <!-- 학생 조회 탭 -->
        <div id="studentTab" class="tab-content active">
            <div class="instructions">
                <h3>📋 성적 조회 방법 (고3)</h3>
                <p>• <strong>출결번호로 검색:</strong> 본인의 4자리 출결번호를 입력하세요</p>
                <p>• 예시: 2274, 1234, 0338 등</p>
                <p>• <strong>🧠 분석:</strong> 성적 조회 시 자동으로 개인별 맞춤 분석을 제공합니다</p>
                <p>• <strong>📝 선택과목:</strong> 화법과 작문 / 언어와 매체별 등급컷이 다르게 적용됩니다</p>
                <div id="urlInfo" style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50; display: none;">
                    <strong>💡 더 쉬운 접속 방법:</strong><br>
                    다음 URL을 북마크하면 어떤 기기에서든 바로 사용할 수 있습니다:<br>
                    <code id="shareableUrl" style="background: white; padding: 5px; border-radius: 4px; font-size: 0.9em;"></code>
                </div>
            </div>
            
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="출결번호를 입력하세요 (예: 2274)" maxlength="4">
                    <button onclick="searchStudent()" class="search-btn" id="searchBtn">🔍 조회</button>
                </div>
            </div>
            
            <div id="noData" class="no-data">
                <h3>📋 데이터 상태</h3>
                <p id="dataStatusMessage">온라인 데이터를 불러오는 중...</p>
            </div>
            
            <div id="results" style="display: none;">
                <div id="studentInfo"></div>
                
                <!-- 분석 섹션 -->
                <div id="aiAnalysis" class="ai-analysis" style="display: none;">
                    <div class="ai-analysis-header">
                        <div class="ai-icon">🧠</div>
                        <div>
                            <h3>학습 분석 보고서 (고3)</h3>
                            <p style="opacity: 0.9; margin: 0;">개인별 맞춤 성적 분석 및 학습 전략 제안</p>
                        </div>
                    </div>
                    
                    <div id="aiContent" class="ai-content">
                        <div class="ai-loading">
                            <span>🧠 고3 성적을 분석하고 있습니다</span>
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 🆕 새로운 간소화된 학습 계획서 섹션 -->
<div id="studyPlanSection" class="ai-analysis" style="display: none; margin-top: 20px;">
    <div class="ai-analysis-header">
        <div class="ai-icon">📋</div>
        <div>
            <h3>맞춤형 학습 계획서</h3>
            <p style="opacity: 0.9; margin: 0;">AI 분석 기반 개인별 최적화 학습 전략</p>
        </div>
    </div>
    
    <div id="studyPlanContent" class="ai-content">
        <div id="autoGeneratedPlan" style="display: none;">
            <!-- 자동 생성된 계획서가 여기에 표시됩니다 -->
        </div>
    </div>
</div>
                
                <div id="summaryTable"></div>
                <div id="gradeCards" class="grade-cards"></div>
            </div>
            
            <div id="noResults" class="no-results" style="display: none;">
                <h3>🔍 검색 결과가 없습니다</h3>
                <p>입력하신 출결번호를 다시 확인해주세요.</p>
            </div>
        </div>
        
        <!-- 관리자 탭 (기존과 동일하므로 생략) -->
        <div id="adminTab" class="tab-content">
            <!-- 관리자 인증 섹션 -->
            <div id="adminAuthSection" class="admin-check">
                <h3>🔐 관리자 인증</h3>
                <p>관리자 기능을 사용하려면 비밀번호를 입력해주세요.</p>
                <input type="password" id="adminPassword" class="admin-password" placeholder="관리자 비밀번호를 입력하세요" onkeypress="if(event.key==='Enter') checkAdminPassword()">
                <br>
                <button onclick="checkAdminPassword()" class="admin-btn">🔑 인증</button>
                <button onclick="resetAdminAccess()" class="admin-btn" style="background: #dc3545; color: white;">🔄 초기화</button>
                
                
            </div>
            
            <!-- GitHub 저장소 설정 섹션 -->
            <div id="githubSetup" class="setup-section">
                <h3>🔧 GitHub 저장소 설정</h3>
                <p><strong>처음 사용 시 한 번만 설정하면 됩니다!</strong></p>
                <p>1. GitHub에서 새 저장소를 만드세요 (예: grade3-data)</p>
                <p>2. 저장소를 Public으로 설정하고 GitHub Pages를 활성화하세요</p>
                <p>3. 아래에 저장소 정보를 입력하세요:</p>
                
                <input type="text" id="githubUsername" class="setup-input" placeholder="GitHub 사용자명 (예: myusername)" autocomplete="off">
                <input type="text" id="githubRepo" class="setup-input" placeholder="저장소 이름 (예: grade3-data)" autocomplete="off">
                <input type="password" id="githubToken" class="setup-input" placeholder="GitHub Personal Access Token (선택사항)">
                
                <button onclick="saveGitHubConfig()" class="setup-btn">설정 저장</button>
                <button onclick="testGitHubConnection()" class="setup-btn">연결 테스트</button>
                
                <p style="margin-top: 15px; font-size: 0.9em;">
                    <strong>📌 GitHub Token 발급 방법:</strong><br>
                    GitHub → Settings → Developer settings → Personal access tokens → Generate new token<br>
                    권한: repo (전체 저장소 접근 권한) 선택
                </p>
            </div>
            
            <!-- 파일 업로드 섹션 -->
            <div id="uploadSection" style="display: none;">
                <div class="instructions">
                    <h3>⚙️ 관리자 영역 (고3)</h3>
                    <p>• 고3 엑셀 파일을 업로드하여 성적 데이터를 GitHub에 저장합니다</p>
                    <p>• 업로드된 데이터는 모든 기기에서 접근 가능합니다</p>
                    <p>• 지원 파일 형식: .xlsx, .xls</p>
                    <p>• <strong>고3 특화:</strong> 선택과목별 등급컷 및 문제 35-45번 처리</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <h3>📁 고3 엑셀 파일 업로드</h3>
                    <p>파일을 드래그앤드롭하거나 아래 버튼을 클릭하세요</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">파일 선택</button>
                    <button class="upload-btn" onclick="processFileAndUpload()" id="processBtn" disabled>GitHub에 업로드</button>
                </div>
            </div>
            
            <div class="progress" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <div class="status" id="statusMessage"></div>
            
            <div class="data-summary" id="dataSummary">
                <h3>📊 업로드된 데이터 현황</h3>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>
        </div>
    </div>

    <script>


// 🆕 정동민국어논술학원 실제 구글드라이브 학습 자료 링크 데이터베이스 (고3용)
var studyMaterialsDB = {
    "독서(인문 이론)": {
        "기본": [
            {
                name: "독서 인문 철학 기초",
                url: "https://drive.google.com/file/d/1Jh6h_XVFYMbsKkljwNA3WP7ZjUg8cZ11/view?usp=drive_link",
                description: "인문·철학 지문 기초 다지기"
            }
        ],
        "심화": [
            {
                name: "독서 인문 사회 심화",
                url: "https://drive.google.com/file/d/1wXD1xGlMMtQn34_07Y_11jovcNvXH5gc/view?usp=drive_link",
                description: "인문·사회 복합 지문 심화 학습"
            }
        ]
    },
    "독서(사회)": {
        "기본": [
            {
                name: "독서 사회 경제 기초",
                url: "https://drive.google.com/file/d/1VvA5ba5egy3-cq8ekWZrKuEpVsSWw-fl/view?usp=drive_link",
                description: "사회·경제 지문 기초 완성"
            }
        ],
        "심화": [
            {
                name: "독서 사회 경제 심화2",
                url: "https://drive.google.com/file/d/1F9Hogy9j6A92zwlBE8aJOU4wqb2Py7Cs/view?usp=drive_link",
                description: "사회·경제 고난도 지문 정복"
            }
        ]
    },
    "독서(과학)": {
        "기본": [
            {
                name: "독서 과학 기초",
                url: "https://drive.google.com/file/d/1gcElUHAEJ6aa0aiV53HoBNd7DXc5GZah/view?usp=drive_link",
                description: "과학 지문 기초 실력 다지기"
            }
        ],
        "심화": [
            {
                name: "독서 과학 심화",
                url: "https://drive.google.com/file/d/1aMlCh4f4xCyR81oDdHweBzauGlNh5hCB/view?usp=drive_link",
                description: "과학 지문 고난도 문제 완전 정복"
            }
        ]
    },
    "문학(현대시)": {
        "기본": [
            {
                name: "문학 시 종합 기초1",
                url: "https://drive.google.com/file/d/1JZCK5w2TediHz1JAv2LG-Dazkt_xgb8k/view?usp=drive_link",
                description: "현대시·고전시가 기초 완성"
            }
        ],
        "심화": [
            {
                name: "문학 현대시 심화",
                url: "https://drive.google.com/file/d/1CMmDDBUPRBmr63GV_y0EvnNyTsozl5u9/view?usp=drive_link",
                description: "현대시 고난도 문제 완전 정복"
            }
        ]
    },
    "문학(현대소설)": {
        "기본": [
            {
                name: "문학 소설종합 기초",
                url: "https://drive.google.com/file/d/1pCNTOOPmLpXcaXrRpkELE0dG4wvBpsfS/view?usp=drive_link",
                description: "현대소설·고전소설 기초 완성"
            }
        ],
        "심화": []
    },
    "문학(고전시가)": {
        "기본": [
            {
                name: "문학 고전시가 기초",
                url: "https://drive.google.com/file/d/1WDY_n8NIokdSx7xjivsMiOg01hNnJKvz/view?usp=drive_link",
                description: "고전시가 기초 완전 정복"
            }
        ],
        "심화": [
            {
                name: "문학 고전시가 심화",
                url: "https://drive.google.com/file/d/1VkTFSQiRAIoyHbAmz4f7FhuXGSbSDCTI/view?usp=drive_link",
                description: "고전시가 고난도 문제 완전 정복"
            }
        ]
    },
    "문학(고전소설)": {
        "기본": [
            {
                name: "문학 고전소설 기초",
                url: "https://drive.google.com/file/d/17-dgV_wngT5QxOYBeusMHTAFKDNrPpcc/view?usp=drive_link",
                description: "고전소설 기초 완전 정복"
            }
        ],
        "심화": [
            {
                name: "문학 고전소설 심화",
                url: "https://drive.google.com/file/d/1qHvAH6fVK0LNzjG28TAiUw5XAv-crO1c/view?usp=drive_link",
                description: "고전소설 고난도 문제 완전 정복"
            }
        ]
    },
    "언어 화법": {
        "기본": [
            {
                name: "화법 기초",
                url: "https://drive.google.com/file/d/1asKNJifDXFQso-e5zP9DjH8HT5cxY0js/view?usp=drive_link",
                description: "화법의 기초를 다지는 필수 문제집"
            }
        ],
        "심화": [
            {
                name: "화법 심화",
                url: "https://drive.google.com/file/d/1aMPZD1Q5OTIjrQHVx2toqzQrZfHbHEOp/view?usp=drive_link",
                description: "고난도 화법 문제 완전 정복"
            }
        ]
    },
    "매체 작문": {
        "기본": [
            {
                name: "작문 기초",
                url: "https://drive.google.com/file/d/1bcUdiiC-fMD-YbWZefIem3vZhJKNtGMg/view?usp=drive_link",
                description: "작문의 기초를 다지는 필수 문제집"
            }
        ],
        "심화": [
            {
                name: "작문 심화",
                url: "https://drive.google.com/file/d/10zxhT-TtlrpRuaZ3l0Hx0hvzZ6XR0Cs2/view?usp=drive_link",
                description: "고난도 작문 문제 완전 정복"
            }
        ]
    },
    "종합모의고사": {
        "기본": [
            {
                name: "종합 모의고사 기초",
                url: "https://drive.google.com/file/d/1qOkQKIX1lWt37tNxePyTjINXB6MNcayG/view?usp=drive_link",
                description: "종합 실력 점검용 기초 모의고사"
            }
        ],
        "심화": [
            {
                name: "종합 비기출 모의고사 1회",
                url: "https://drive.google.com/file/d/1IgMkqG6TGaqXnn6hGgN4nOeY3X0SuSlF/view?usp=sharing",
                description: "최신 비기출 문제 종합 모의고사"
            }
        ]
    },
    "매일학습": {
        "기본": [
            {
                name: "매일 푸는 주간지 1",
                url: "https://drive.google.com/file/d/1bcUdiiC-fMD-YbWZefIem3vZhJKNtGMg/view?usp=drive_link",
                description: "매일 꾸준히 풀 수 있는 학습지"
            }
        ],
        "심화": [
            {
                name: "매일 푸는 주간지 6",
                url: "https://drive.google.com/file/d/1dhjMMd3-7Nnbr515Z7RjtHFTSRTvBoJ5/view?usp=drive_link",
                description: "심화 단계 매일 학습지"
            }
        ]
    }
};

// 🆕 현재 주차 계산 함수
function getCurrentWeekNumber() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const diff = now - start;
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    const weekNumber = Math.ceil(diff / oneWeek);
    
    console.log('📅 올해 ' + now.getFullYear() + '년 ' + weekNumber + '주차');
    
    return ((weekNumber - 1) % 52) + 1;
}

// 🆕 등급별 학습 계획 설정 함수
function getStudyPlanConfig(averageGrade) {
    if (averageGrade <= 2) {
        return {
            studyDays: 3,
            dailySubjects: 2,
            weekdayLimit: 60,
            weekendLimit: 50,
            dailyWorkbook: ['월', '수', '금']
        };
    } else if (averageGrade <= 4) {
        return {
            studyDays: 5,
            dailySubjects: 3,
            weekdayLimit: 100,
            weekendLimit: 50,
            dailyWorkbook: ['월', '화', '수', '목', '금']
        };
    } else {
        return {
            studyDays: 7,
            dailySubjects: 3,
            weekdayLimit: 100,
            weekendLimit: 50,
            dailyWorkbook: ['월', '화', '수', '목', '금', '토', '일']
        };
    }
}

// 🆕 체계적인 학습 자료 추천
function getSystematicStudyMaterials(subjectName, currentScore, isMainStudy = true) {
    const materials = [];
    const currentWeek = getCurrentWeekNumber();
    
    console.log('🔍 학습자료 검색:', subjectName, '점수:', currentScore);
    
    // 고3 과목명 매핑
    const subjectMapping = {
        '독서(인문 이론)': '독서(인문 이론)',
        '독서(사회)': '독서(사회)',
        '독서(과학)': '독서(과학)',
        '문학(현대시)': '문학(현대시)',
        '문학(현대소설)': '문학(현대소설)',
        '문학(고전시가)': '문학(고전시가)',
        '문학(고전소설)': '문학(고전소설)',
        '언어 화법': '언어 화법',
        '매체 작문': '매체 작문'
    };
    
    const mappedSubject = subjectMapping[subjectName] || subjectName;
    console.log('📝 매핑된 과목명:', subjectName, '→', mappedSubject);
    
    // 주 교재 추천
    if (isMainStudy && studyMaterialsDB[mappedSubject]) {
        let levelsToInclude = [];
        
        if (currentScore < 60) {
            levelsToInclude = ["기본"];
        } else if (currentScore <= 80) {
            levelsToInclude = ["기본", "심화"];
        } else {
            levelsToInclude = ["심화"];
        }
        
        levelsToInclude.forEach(level => {
            if (studyMaterialsDB[mappedSubject][level] && studyMaterialsDB[mappedSubject][level].length > 0) {
                studyMaterialsDB[mappedSubject][level].forEach((material, index) => {
                    materials.push({
                        ...material,
                        studyTime: 40,
                        type: "main"
                    });
                });
            }
        });
    }
    
    // 매일 푸는 주간지 추가
    if (studyMaterialsDB["매일학습"]) {
        const allWeeklyMaterials = [
            ...studyMaterialsDB["매일학습"]["기본"],
            ...studyMaterialsDB["매일학습"]["심화"]
        ];
        
        if (allWeeklyMaterials.length > 0) {
            const weeklyIndex = (currentWeek - 1) % 10;
            materials.push({
                ...allWeeklyMaterials[weeklyIndex],
                studyTime: 20,
                type: "daily"
            });
        }
    }
    
   // 종합 자료로 대체
    const hasMainMaterial = materials.some(m => m.type === "main");
    if (!hasMainMaterial && studyMaterialsDB["종합모의고사"]) {
        const level = currentScore < 60 ? "기본" : "심화";
        const generalMaterials = studyMaterialsDB["종합모의고사"][level];
        
        if (generalMaterials && generalMaterials.length > 0) {
            generalMaterials.forEach((material, index) => {
                materials.push({
                    ...material,
                    studyTime: 30,
                    type: "general"
                });
            });
        }
    }
    
    return materials;
}

// 🆕 상세 학습 과제 생성 함수 (고3용)
function getDetailedStudyTask(subject, currentScore) {
    const tasks = {
        '독서(인문 이론)': {
            basic: '철학 기본 용어(존재론, 인식론, 윤리학) 정리 → 미학·예술론 기초 개념 학습 → 지문 구조 파악(문제제기→논증→결론) → 핵심 내용과 세부 내용 구분 연습',
            advanced: '복잡한 논리 구조와 추론 과정 분석 → 함축적 의미와 행간 읽기 → 동서양 철학 사상 비교 분석 → 빠른 독해 훈련(분당 800자 이상) → 시간 단축 스키밍 기법'
        },
        '독서(사회)': {
            basic: '경제학 기본 개념(수요공급, 시장경제) 정리 → 정치학·사회학·법학 기초 용어 학습 → 원인-결과 관계 분석 → 문제점-해결방안 구조 이해 → 통계 자료 해석 방법',
            advanced: '다층적 사회 현상의 상호작용 분석 → 정책의 효과와 부작용 분석 → 제도적 변화의 배경과 결과 파악 → 복합 사회 문제의 종합적 이해 → 고난도 지문 정복'
        },
        '독서(과학)': {
            basic: '물리·화학·생물·지구과학 기본 용어 정리 → 실험 설계와 과정 이해 → 가설 설정과 검증 방법 → 관찰 결과 분석과 해석 → 과정 순서도 그리기 연습',
            advanced: '복잡한 과학 원리와 법칙 이해 → 최신 과학 기술 동향 파악 → 과학사적 발견과 패러다임 변화 → 고난도 실험·기술 지문 분석 → 인과관계 완벽 파악'
        },
        '문학(현대시)': {
            basic: '화자와 상황 설정 분석 → 주요 시어의 함축적 의미 파악 → 화자의 정서와 어조 분석 → 비유법(은유, 환유, 의인법) 이해 → 대조법·점층법·영탄법 학습',
            advanced: '다층적 화자 의식과 관점 변화 추적 → 시간·공간 의식 심층 분석 → 상징과 은유의 심층 의미 파악 → 문학사적 흐름과 사조 이해 → 작가 특유의 문체와 개성 분석'
        },
        '문학(현대소설)': {
            basic: '인물 관계도 작성 및 성격 분석 → 사건의 발단-전개-위기-절정-결말 정리 → 갈등 구조(인물간·내적·사회적) 파악 → 시공간적 배경의 의미 → 주제 의식 파악',
            advanced: '시점과 서술자의 역할 분석 → 서술 순서(순행·역행·교차) 파악 → 의식의 흐름·내적 독백 분석 → 문학사적 의의와 사조 이해 → 작가의식과 작품 세계 탐구'
        },
        '문학(고전시가)': {
            basic: '갈래와 형식(향가·고려가요·시조·가사) 구분 → 운율과 율격(3·4조, 4·4조) 파악 → 고어의 현대어 풀이 암기 → 화자의 정서와 상황 → 주요 소재의 관습적 의미',
            advanced: '시상 전개 과정(선경후정·기승전결) 분석 → 시대별 문학 특성 이해 → 작가와 작품의 문학사적 의의 → 갈래별 특징과 변천사 → 당대 사회상과 연관 지어 감상'
        },
        '문학(고전소설)': {
            basic: '등장인물의 성격과 역할 파악 → 사건 전개와 구성 정리 → 갈등 구조와 해결 과정 → 권선징악 구조 이해 → 신분제 비판 의식과 현실 비판 파악',
            advanced: '전지적 서술과 개입적 서술 분석 → 판소리계 소설의 특징 → 가문소설과 영웅소설 구조 비교 → 문학사적 가치와 의의 → 현대 문학과의 연관성 및 민족 문학으로서의 가치'
        },
        '언어 화법': {
            basic: '화법의 기본 원리 학습(상황, 목적, 청자 파악) → 화자 의도와 청자 반응 분석 → 말하기 전략과 기법 → 토론과 협상의 원리 → 기본 화법 문제 패턴 익히기',
            advanced: '복합 화법 상황의 다각적 요소 분석 → 화자 의도와 청자 반응의 심층 분석 → 설득 전략과 논증 구조 → 고급 토론 및 발표 기법 → 실전 시간 단축 기법 연습'
        },
        '매체 작문': {
            basic: '작문 과정(계획→작성→수정) 이해 → 글의 유형별 특성 파악 → 고쳐쓰기 기본 원리 → 매체 언어의 특성 → 기본 작문 문제 패턴 익히기',
            advanced: '작문 유형별 세부 전략 수립 → 고쳐쓰기 함정 패턴 분석 → 매체별 언어 사용 양상 → 디지털 매체의 소통 방식 → 고급 작문 및 매체 문제 정복'
        }
    };
    
    const subjectTasks = tasks[subject];
    if (!subjectTasks) return '기본 개념 학습 및 문제 풀이 연습을 통한 실력 향상';
    
    return currentScore < 60 ? subjectTasks.basic : subjectTasks.advanced;
}

// 🆕 자동 생성된 학습 계획서 표시 함수
function displayAutoGeneratedPlan(planData) {
    const planContainer = document.getElementById('autoGeneratedPlan');
    const { student, weakSubjects, weeklyPlan, config, averageGrade } = planData;
    
    if (weakSubjects.length === 0) {
        displayExcellentStudentPlan(student);
        return;
    }
    
    const currentWeek = getCurrentWeekNumber();
    
    planContainer.innerHTML = `
        <div class="advanced-study-plan">
            <div class="plan-document-header">
                <h3>📋 ${student.name}님 맞춤 학습 계획서 (고3)</h3>
                <div class="student-info-banner">
                    <strong>${student.name} 학생</strong> - 개인별 약점 분석 기반 최적화 계획
                </div>
            </div>
            
            <div class="improvement-analysis">
                <h4 style="margin-bottom: 15px; color: rgba(255,255,255,0.95);">
                    ⚠️ 우선 개선 과목 (상위 3개)
                </h4>
                
                ${weakSubjects.map((subject, index) => {
                    const materials = getSystematicStudyMaterials(subject.name, subject.current, true);
                    const studyTask = getDetailedStudyTask(subject.name, subject.current);
                    return `
                        <div class="weak-subject-card priority-${subject.priority}">
                            <div class="subject-header">
                                <div class="subject-name">${subject.name}</div>
                                <div class="priority-badge priority-${subject.priority}">
                                    ${subject.priority === 'high' ? '🔴 최우선' : subject.priority === 'medium' ? '🟡 중요' : '🔵 보통'}
                                </div>
                            </div>
                            
                            <div class="subject-details">
                                <div class="detail-metric">
                                    <div class="detail-value">${subject.current}%</div>
                                    <div class="detail-label">현재 성취도</div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <h5 style="margin-bottom: 10px; color: rgba(255,255,255,0.95);">📋 취약영역 개념 클리닉</h5>
                                <p style="color: rgba(255,255,255,0.85); line-height: 1.5; font-size: 0.9em;">${studyTask}</p>
                            </div>
                            
                            <div class="study-materials">
                                <h5 style="margin-bottom: 10px;">📚 추천 학습 자료 다운로드 링크</h5>
                                <div class="material-links">
                                    ${materials.map(material => `
                                        <a href="${material.url}" target="_blank" class="material-link">
                                            ⬇️ ${material.name}
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            ${createWeeklyScheduleHTML(weeklyPlan)}
            
            <div class="motivation-banner">
                <h4>${student.name}님을 위한 격려 메시지</h4>
                <div class="motivation-text">
                    현재 ${averageGrade.toFixed(1)}등급에서 ${Math.max(1, Math.floor(averageGrade) - 1)}등급으로 향상하기 위한
                    체계적인 계획을 수립했습니다. 수능까지 남은 시간을 효율적으로 활용하여 반드시 목표를 달성할 수 있습니다! 
                    정동민국어논술학원이 여러분의 성공을 응원합니다! 💪
                </div>
            </div>
        </div>
    `;
}

// 🆕 자동 학습 계획서 생성 (AI 분석 직후 호출)
function generateAutoStudyPlan(student) {
    console.log('자동 학습 계획서 생성 시작:', student.name);
    
    const analysisResult = performAIAnalysis(student);
    const aiWeaknesses = analysisResult.weaknesses || [];
    
    if (aiWeaknesses.length === 0) {
        displayExcellentStudentPlan(student);
        return;
    }
    
    const grades = student.grades;
    const gradeKeys = Object.keys(grades);
    const recent4Grades = gradeKeys.slice(-4).map(key => parseInt(grades[key].grade));
    const averageGrade = recent4Grades.reduce((a, b) => a + b, 0) / recent4Grades.length;
    
    const weakSubjects = aiWeaknesses.slice(0, 3).map(weakness => ({
        name: weakness.subject,
        current: weakness.average,
        improvement: 85 - weakness.average,
        priority: weakness.urgency,
        description: weakness.description
    }));

    const weeklyPlan = generateRealisticWeeklyPlan(weakSubjects, averageGrade);
    const config = getStudyPlanConfig(averageGrade);
    
    displayAutoGeneratedPlan({
        student: student,
        weakSubjects: weakSubjects,
        weeklyPlan: weeklyPlan,
        config: config,
        averageGrade: averageGrade
    });
    
    document.getElementById('autoGeneratedPlan').style.display = 'block';
}

// 🆕 현실적인 주간 계획 생성
function generateRealisticWeeklyPlan(weakSubjects, averageGrade) {
    const config = getStudyPlanConfig(averageGrade);
    const days = ['월', '화', '수', '목', '금', '토', '일'];
    const plan = {};
    
    days.forEach(day => {
        plan[day] = [];
    });
    
    const currentWeek = getCurrentWeekNumber();
    const dailyWorkbook = studyMaterialsDB["매일학습"] ? 
        [...studyMaterialsDB["매일학습"]["기본"], ...studyMaterialsDB["매일학습"]["심화"]] : [];
    
    if (dailyWorkbook.length > 0) {
        const weeklyIndex = (currentWeek - 1) % dailyWorkbook.length;
        const selectedWorkbook = dailyWorkbook[weeklyIndex];
        
        config.dailyWorkbook.forEach(day => {
            plan[day].push({
                subject: "매일 푸는 주간지",
                material: selectedWorkbook.name,
                time: 20,
                priority: "daily",
                url: selectedWorkbook.url,
                description: selectedWorkbook.description
            });
        });
    }
    
    let dayIndex = 0;
    const studyDays = days.slice(0, config.studyDays);
    
    weakSubjects.forEach((subject, subjectIndex) => {
        const materials = getSystematicStudyMaterials(subject.name, subject.current, true);
        
        materials.forEach(material => {
            if (material.type === "main") {
                const targetDay = studyDays[dayIndex % studyDays.length];
                const isWeekend = targetDay === '토' || targetDay === '일';
                const timeLimit = isWeekend ? config.weekendLimit : config.weekdayLimit;
                const currentTime = plan[targetDay].reduce((sum, item) => sum + item.time, 0);
                
                if (currentTime + material.studyTime <= timeLimit) {
                    plan[targetDay].push({
                        subject: subject.name,
                        material: material.name,
                        time: material.studyTime,
                        priority: subject.priority,
                        url: material.url,
                        description: material.description
                    });
                    
                    dayIndex++;
                }
            }
        });
    });
    
    return plan;
}

// 🆕 우수 학생용 계획서
function displayExcellentStudentPlan(student) {
    const planContainer = document.getElementById('autoGeneratedPlan');
    const currentWeek = getCurrentWeekNumber();
    
    planContainer.innerHTML = `
        <div class="advanced-study-plan">
            <div class="plan-document-header">
                <h3>🌟 우수 학생 맞춤 계획서 (고3)</h3>
                <div class="student-info-banner">
                    <strong>${student.name} 학생</strong> - 모든 영역에서 뛰어난 성취도!
                </div>
            </div>
            
            <div style="text-align: center; padding: 30px; background: rgba(40,167,69,0.1); border-radius: 12px;">
                <h4 style="color: #28a745; margin-bottom: 15px;">🎉 축하합니다!</h4>
                <p style="line-height: 1.6; margin-bottom: 20px;">
                    현재 모든 과목에서 우수한 성취도를 보이고 있습니다.<br>
                    수능까지 현재 수준을 유지하며 실전 감각을 기르는 것을 추천합니다.
                </p>
                
                <div class="study-materials">
                    <h5 style="margin-bottom: 15px;">📚 추천 학습 자료</h5>
                    <div class="material-links">
                        ${studyMaterialsDB["종합모의고사"]["심화"].map(material => `
                            <a href="${material.url}" target="_blank" class="material-link">
                                ⬇️ ${material.name}
                            </a>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 🆕 주간 스케줄 HTML 생성 함수
function createWeeklyScheduleHTML(weeklyPlan) {
    const days = ['월', '화', '수', '목', '금', '토', '일'];
    
    let html = `
        <div class="weekly-schedule-advanced">
            <h4 style="margin-bottom: 15px; color: rgba(255,255,255,0.95);">
                📅 주간 맞춤 학습 스케줄
            </h4>
            <div style="margin-bottom: 20px; opacity: 0.9; line-height: 1.5;">
                과목별 우선순위와 개인 약점을 고려하여 최적화된 주간 계획입니다.
                매일 정해진 시간에 꾸준히 실천하는 것이 핵심입니다! 학습 자료는 위 추천학습자료 다운로드 링크를 이용하세요.
            </div>
            
            <div class="schedule-week-grid">
    `;
    
    days.forEach(day => {
        html += `
            <div class="schedule-day">
                <div class="day-name">${day}요일</div>
        `;
        
        if (weeklyPlan[day] && weeklyPlan[day].length > 0) {
            let totalTime = 0;
            weeklyPlan[day].forEach(session => {
                const priorityColor = {
                    'high': 'rgba(220, 53, 69, 0.3)',
                    'medium': 'rgba(255, 193, 7, 0.3)',
                    'low': 'rgba(23, 162, 184, 0.3)'
                };
                
                html += `
                    <div class="study-session" style="background: ${priorityColor[session.priority] || priorityColor.medium};">
                        <div class="session-subject">${session.subject}</div>
                        <div class="session-time">${session.time}분</div>
                    </div>
                `;
                totalTime += session.time;
            });
            
            html += `<div style="margin-top: 8px; font-size: 0.75em; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">총 ${totalTime}분</div>`;
        } else {
            html += `<div class="study-session">자유 학습</div>`;
        }
        
        html += `</div>`;
    });
    
    html += `
        </div>
        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center;">
            <strong>💡 학습 효과 극대화 팁</strong><br>
            🔴 최우선 과목은 집중력이 좋은 저녁 시간에 | 🟡 중요 과목은 컨디션이 좋은 주말에 | 학습 자료는 위 추천학습자료 다운로드 링크를 이용하세요.
        </div>
    </div>
    `;
    
    return html;
}

// 🆕 등급별 목표 점수 반환 함수
function getTargetScoreFromGrade(grade) {
    const scoreMap = {
        '1': 92,
        '2': 82,
        '3': 72,
        '4': 62,
        '5': 52
    };
    return scoreMap[grade] || 80;
}
    
        // 학업 운세 데이터
        var fortuneData = {
            excellent: {
                icon: "⭐",
                title: "최고의 학습일!",
                stars: "⭐⭐⭐⭐⭐",
                color: "from-yellow-400 to-orange-500",
                bgColor: "rgba(255, 215, 0, 0.1)",
                advice: [
                    "새로운 개념을 배우기에 최적의 날입니다",
                    "어려운 문제에 도전해보세요",
                    "그룹 스터디나 토론이 특히 효과적일 것입니다",
                    "오늘 배운 내용은 오래 기억될 것입니다",
                    "평소보다 1.5배 많은 분량을 소화할 수 있어요",
                    "창의적인 문제 해결 방법을 시도해보세요",
                    "선생님께 어려운 질문을 던져보세요",
                    "새로운 학습 앱이나 도구를 활용해보세요"
                ],
                studyTips: [
                    "오늘은 평소보다 30% 더 집중할 수 있는 날입니다!",
                    "가장 어려운 과목부터 시작해보세요!",
                    "새로운 학습법을 시도하기 최적의 날이에요!",
                    "친구들과 스터디 그룹을 만들어보세요!"
                ]
            },
            verygood: {
                icon: "🌟",
                title: "매우 좋은 학습 기운!",
                stars: "⭐⭐⭐⭐",
                color: "from-orange-400 to-red-500",
                bgColor: "rgba(255, 140, 0, 0.1)",
                advice: [
                    "집중력이 뛰어난 날입니다",
                    "중요한 개념 정리에 최적입니다",
                    "암기보다는 이해 중심으로 공부하세요",
                    "선생님께 질문하기 좋은 날이에요",
                    "복잡한 공식이나 개념을 마스터하기 좋습니다",
                    "논리적 사고가 필요한 과목에 집중하세요",
                    "예습보다는 심화 학습에 시간을 투자하세요",
                    "오늘 정리한 내용은 시험에 나올 확률이 높아요"
                ],
                studyTips: [
                    "깊이 있는 학습에 집중해보세요!",
                    "어려운 문제집을 도전해보는 날이에요!",
                    "개념 연결 고리를 찾아보세요!",
                    "오늘 배운 내용을 친구에게 설명해보세요!"
                ]
            },
            good: {
                icon: "📈",
                title: "좋은 학습 흐름!",
                stars: "⭐⭐⭐⭐",
                color: "from-green-400 to-blue-500",
                bgColor: "rgba(76, 175, 80, 0.1)",
                advice: [
                    "꾸준한 복습이 큰 효과를 가져올 것입니다",
                    "계획을 세워 체계적으로 공부하세요",
                    "노트 정리가 특히 잘 될 것입니다",
                    "친구와 함께 공부하면 더욱 효과적입니다",
                    "시간 관리가 평소보다 잘 될 것입니다",
                    "단계별로 차근차근 진행하는 것이 좋아요",
                    "오답노트 정리하기에 최적의 날입니다",
                    "여러 과목을 골고루 공부하세요"
                ],
                studyTips: [
                    "포모도로 기법(25분 집중 + 5분 휴식)을 활용해보세요!",
                    "컬러펜으로 중요한 부분을 표시해보세요!",
                    "계획표를 만들어서 체크하며 공부해보세요!",
                    "배경음악을 들으며 공부하면 더 효과적일 거예요!"
                ]
            },
            normal: {
                icon: "📚",
                title: "평범한 학습일",
                stars: "⭐⭐⭐",
                color: "from-blue-400 to-purple-500",
                bgColor: "rgba(33, 150, 243, 0.1)",
                advice: [
                    "기본기를 다지는 데 집중하세요",
                    "무리하지 말고 꾸준히 공부하는 것이 좋습니다",
                    "휴식과 학습의 균형을 맞추세요",
                    "가벼운 복습으로 시작해보세요",
                    "기초 문제부터 차근차근 풀어보세요",
                    "부담스럽지 않은 분량으로 계획을 세우세요",
                    "평소 좋아하는 과목부터 시작하세요",
                    "충분한 수면과 휴식을 취하며 공부하세요"
                ],
                studyTips: [
                    "오늘은 가벼운 독서나 요약 정리가 좋겠어요!",
                    "기본 개념 위주로 천천히 공부해보세요!",
                    "스트레칭을 자주 하며 공부하세요!",
                    "좋아하는 간식을 준비해서 공부해보세요!"
                ]
            },
            caution: {
                icon: "⚡",
                title: "주의가 필요한 학습일",
                stars: "⭐⭐",
                color: "from-yellow-500 to-orange-600",
                bgColor: "rgba(255, 152, 0, 0.1)",
                advice: [
                    "산만해지기 쉬우니 환경을 정리하세요",
                    "짧은 시간이라도 집중해서 공부하세요",
                    "스마트폰을 멀리 두고 공부하세요",
                    "계획을 단순하게 세우는 것이 좋습니다",
                    "한 번에 한 과목만 집중하세요",
                    "조용한 장소에서 공부하는 것이 좋아요",
                    "복잡한 내용보다 간단한 것부터 시작하세요",
                    "친구들과의 잡담은 잠시 미뤄두세요"
                ],
                studyTips: [
                    "오늘은 한 과목에만 집중해보세요!",
                    "타이머를 설정해서 짧게 짧게 공부해보세요!",
                    "핸드폰을 다른 방에 두고 공부하세요!",
                    "간단한 문제부터 차근차근 풀어보세요!"
                ]
            },
            challenging: {
                icon: "🧠",
                title: "집중력 필요한 날",
                stars: "⭐⭐",
                color: "from-purple-400 to-pink-500",
                bgColor: "rgba(156, 39, 176, 0.1)",
                advice: [
                    "어려운 내용은 피하고 쉬운 것부터 시작하세요",
                    "친구나 선생님과 함께 공부하면 도움이 될 것입니다",
                    "충분한 휴식을 취하며 공부하세요",
                    "무리하지 말고 기본 개념만 점검해보세요",
                    "혼자 하기 어려운 내용은 도움을 요청하세요",
                    "완벽을 추구하기보다 이해에 중점을 두세요",
                    "스트레스를 받지 말고 여유롭게 접근하세요",
                    "평소보다 휴식 시간을 늘려가며 공부하세요"
                ],
                studyTips: [
                    "오늘은 복습 위주로 가볍게 공부하세요!",
                    "친구와 함께 공부하면 더 좋을 거예요!",
                    "어려운 문제는 내일로 미뤄도 괜찮아요!",
                    "충분한 휴식을 취하며 천천히 하세요!"
                ]
            },
            review: {
                icon: "🔄",
                title: "복습의 날!",
                stars: "⭐⭐⭐",
                color: "from-indigo-400 to-purple-600",
                bgColor: "rgba(103, 58, 183, 0.1)",
                advice: [
                    "새로운 내용보다 기존 내용 정리에 집중하세요",
                    "오답노트를 점검하기 좋은 날입니다",
                    "헷갈리는 개념들을 다시 정리해보세요",
                    "이전에 어려웠던 문제들을 다시 풀어보세요",
                    "지난주 배운 내용을 훑어보세요",
                    "암기했던 내용들을 다시 점검해보세요",
                    "개념 간의 연결고리를 찾아보세요",
                    "시험 범위를 전체적으로 정리해보세요"
                ],
                studyTips: [
                    "지난주 배운 내용을 훑어보는 시간을 가져보세요!",
                    "오답노트를 꺼내서 다시 풀어보세요!",
                    "형광펜으로 중요한 부분을 다시 체크해보세요!",
                    "친구와 서로 문제를 내며 복습해보세요!"
                ]
            },
            creative: {
                icon: "🎨",
                title: "창의적 학습일!",
                stars: "⭐⭐⭐⭐",
                color: "from-pink-400 to-red-500",
                bgColor: "rgba(233, 30, 99, 0.1)",
                advice: [
                    "마인드맵으로 개념을 정리해보세요",
                    "다양한 학습 방법을 시도해보세요",
                    "그림이나 도표를 활용한 정리가 효과적입니다",
                    "창의적인 문제 해결 방법을 찾아보세요",
                    "스토리텔링으로 개념을 기억해보세요",
                    "색깔과 기호를 활용해서 노트를 정리하세요",
                    "암기보다는 이미지로 연상해서 기억하세요",
                    "새로운 학습 도구나 앱을 활용해보세요"
                ],
                studyTips: [
                    "오늘은 색깔 펜으로 예쁘게 노트 정리를 해보세요!",
                    "마인드맵을 그려가며 공부해보세요!",
                    "그림이나 다이어그램을 그려보세요!",
                    "노래나 리듬에 맞춰서 암기해보세요!"
                ]
            },
            motivated: {
                icon: "🔥",
                title: "동기부여 최고조!",
                stars: "⭐⭐⭐⭐⭐",
                color: "from-red-500 to-pink-600",
                bgColor: "rgba(244, 67, 54, 0.1)",
                advice: [
                    "목표를 높게 설정하고 도전해보세요",
                    "평소 어려워했던 과목에 집중하세요",
                    "장기적인 학습 계획을 세우기 좋은 날입니다",
                    "자신감을 가지고 공부에 임하세요",
                    "도전적인 문제들을 적극적으로 풀어보세요",
                    "새로운 학습 목표를 설정해보세요",
                    "경쟁 의식을 활용해서 공부해보세요",
                    "성취감을 느낄 수 있는 작은 목표들을 만들어보세요"
                ],
                studyTips: [
                    "오늘은 꿈과 목표를 다시 한번 되새겨보세요!",
                    "가장 어려운 문제집을 도전해보세요!",
                    "공부 시간을 평소보다 늘려보세요!",
                    "친구들과 공부 경쟁을 해보세요!"
                ]
            },
            calm: {
                icon: "🧘",
                title: "차분한 학습일",
                stars: "⭐⭐⭐",
                color: "from-teal-400 to-blue-600",
                bgColor: "rgba(0, 150, 136, 0.1)",
                advice: [
                    "차분하게 한 단계씩 공부해나가세요",
                    "명상이나 깊은 호흡으로 마음을 가라앉히세요",
                    "조용한 환경에서 집중력을 발휘할 수 있습니다",
                    "스트레스 없이 여유롭게 공부하세요",
                    "느긋하게 시간을 가지고 이해하며 공부하세요",
                    "마음의 평정을 유지하며 학습에 임하세요",
                    "급하게 서두르지 말고 차근차근 진행하세요",
                    "내면의 집중력을 끌어올려보세요"
                ],
                studyTips: [
                    "조용한 음악을 들으며 공부해보세요!",
                    "깊은 호흡을 하며 마음을 차분히 하세요!",
                    "천천히 읽고 이해하며 공부해보세요!",
                    "명상을 5분 하고 공부를 시작해보세요!"
                ]
            }
        };
        
        // 전체 행운의 과목 목록
        var allLuckySubjects = [
            "국어", "독서(비문학)", "문학", "화법과 작문", "언어와 매체", 
            "수학1", "수학2", "미적분", "확률과 통계", "기하", 
            "영어", "영어듣기", "한국사", "과탐", "사탐", 
            "독서(인문)", "독서(과학)", "독서(사회)", 
            "현대시", "현대소설", "고전시", "고전소설",
            "모든 과목 복습", "모의고사", "영어단어", "암기과목"
        ];
        
        // 학업 운세 계산 함수
        function calculateStudyFortune(name) {
            if (!name) return null;
            
            var sum = 0;
            for (var i = 0; i < name.length; i++) {
                sum += name.charCodeAt(i);
            }
            
            var today = new Date();
            var dateSum = today.getDate() + today.getMonth() + today.getFullYear();
            sum += dateSum;
            
            var fortuneTypes = Object.keys(fortuneData);
            var index = sum % fortuneTypes.length;
            var type = fortuneTypes[index];
            
            // 랜덤하게 조언 3개, 팁 1개, 행운의 과목 2개, 행운의 번호 1개 선택
            var selectedAdvice = fortuneData[type].advice.slice().sort(() => 0.5 - Math.random()).slice(0, 3);
            var selectedTip = fortuneData[type].studyTips[Math.floor(Math.random() * fortuneData[type].studyTips.length)];
            var selectedSubjects = allLuckySubjects.slice().sort(() => 0.5 - Math.random()).slice(0, 2);
            var luckyNumber = Math.floor(Math.random() * 5) + 1; // 1~5 중 랜덤
            
            return {
                type: type,
                data: {
                    ...fortuneData[type],
                    selectedAdvice: selectedAdvice,
                    selectedTip: selectedTip,
                    selectedSubjects: selectedSubjects,
                    luckyNumber: luckyNumber
                }
            };
        }
        
        // 운세 표시 함수
        function displayStudyFortune(name) {
            var fortune = calculateStudyFortune(name);
            if (!fortune) return '';
            
            return `
                <div class="ai-analysis" style="background: linear-gradient(135deg, ${fortune.data.bgColor}, ${fortune.data.bgColor}); color: #333; margin: 20px 0;">
                    <div class="ai-analysis-header">
                        <div class="ai-icon" style="background: ${fortune.data.bgColor}; color: #333;">
                            ${fortune.data.icon}
                        </div>
                        <div>
                            <h3 style="color: #333; font-size: 1.2em;">${name}님의 학업 운세</h3>
                            <div style="font-size: 1.4em; font-weight: bold; margin-top: 6px;">
                                <span style="color: #333;">${fortune.data.title}</span>
                                <span style="color: #FFD700; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); margin-left: 8px;">${fortune.data.stars}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-content">
                        <div style="background: rgba(255, 255, 255, 0.3); border-radius: 10px; padding: 12px; margin: 10px 0;">
                            <h4 style="color: #444; margin-bottom: 10px;">💡 오늘의 학습 조언</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #555;">
                                ${fortune.data.selectedAdvice.map(advice => `<li style="margin-bottom: 5px;">${advice}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <div style="background: rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 15px;">
                                <h4 style="color: #444; margin-bottom: 10px;">📚 행운의 과목</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${fortune.data.selectedSubjects.map(subject => 
                                        `<span style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9em; font-weight: bold; text-align: center;">${subject}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 15px;">
                                <h4 style="color: #444; margin-bottom: 10px;">🍀 행운의 번호</h4>
                                <div style="display: flex; justify-content: center; align-items: center; height: 60px;">
                                    <span style="
                                        background: linear-gradient(45deg, #ff6b6b, #feca57); 
                                        color: white; 
                                        font-size: 2em; 
                                        font-weight: bold; 
                                        width: 50px; 
                                        height: 50px; 
                                        border-radius: 50%; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center;
                                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                    ">${fortune.data.luckyNumber}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 15px; margin: 15px 0;">
                            <h4 style="color: #444; margin-bottom: 10px;">🎯 오늘의 학습 팁</h4>
                            <p style="color: #444; font-weight: 500; margin: 0; font-style: italic;">
                                "${fortune.data.selectedTip}"
                            </p>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #666; text-align: center; margin-top: 10px;">
                            💡 운세는 재미로만 참고하세요. 진짜 중요한 건 꾸준한 노력입니다!
                            <br><br>
                            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                <a href="https://www.instagram.com/swwweet.daekun/" target="_blank" style="
                                    display: inline-flex; 
                                    align-items: center; 
                                    gap: 8px; 
                                    background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D, #F56040, #F77737, #FCAF45, #FFDC80);
                                    color: white; 
                                    text-decoration: none; 
                                    padding: 22px 42px; 
                                    border-radius: 27px; 
                                    font-weight: bold; 
                                    font-size: 1.2em;
                                    transition: transform 0.2s;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    📸 관리자 대건T Instagram
                                </a>
                                <a href="https://jdmedu.github.io/university-predictor/" target="_blank" style="
                                    display: inline-flex; 
                                    align-items: center; 
                                    gap: 8px; 
                                    background: linear-gradient(45deg, #4CAF50, #45a049, #66BB6A, #81C784);
                                    color: white; 
                                    text-decoration: none; 
                                    padding: 22px 42px; 
                                    border-radius: 27px; 
                                    font-weight: bold; 
                                    font-size: 1.2em;
                                    transition: transform 0.2s;
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    🎓 대입 합격 예측 시스템
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 📊 통계 계산 함수
        function calculateStatistics(student) {
            var grades = student.grades;
            var gradeKeys = Object.keys(grades);
            
            if (gradeKeys.length === 0) return null;
            
            var scores = [];
            var gradeValues = [];
            var recentScores = [];
            
            gradeKeys.forEach(function(testName) {
                var gradeData = grades[testName];
                if (gradeData.score) scores.push(parseInt(gradeData.score));
                if (gradeData.grade) gradeValues.push(parseInt(gradeData.grade));
            });
            
            // 최근 3회 점수
            recentScores = scores.slice(-3);
            
            var avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0;
            var avgGrade = gradeValues.length > 0 ? Math.round(gradeValues.reduce((a, b) => a + b) / gradeValues.length * 10) / 10 : 0;
            var bestScore = scores.length > 0 ? Math.max(...scores) : 0;
            var bestGrade = gradeValues.length > 0 ? Math.min(...gradeValues) : 0;
            var latestScore = scores.length > 0 ? scores[scores.length - 1] : 0;
            
            // 성적 변화 계산
            var scoreChange = 0;
            if (scores.length >= 2) {
                var recent2 = scores.slice(-2);
                scoreChange = recent2[1] - recent2[0];
            }
            
            // 상위 퍼센트 계산 (임의 계산)
            var percentile = Math.max(1, Math.min(99, Math.round((100 - avgGrade * 10) + Math.random() * 10)));
            
            return {
                avgScore: avgScore,
                avgGrade: avgGrade,
                bestScore: bestScore,
                bestGrade: bestGrade,
                latestScore: latestScore,
                scoreChange: scoreChange,
                percentile: percentile,
                testCount: gradeKeys.length,
                totalTests: window.discoveredTestSheets ? window.discoveredTestSheets.length : 12
            };
        }
        
        // 분산 계산 헬퍼 함수
        function calculateVariance(numbers) {
            var mean = numbers.reduce((a, b) => a + b) / numbers.length;
            var variance = numbers.reduce((sum, num) => sum + Math.pow(num - mean, 2), 0) / numbers.length;
            return variance;
        }
        
       // 🏆 확장된 뱃지 시스템 (43개)
function generateAchievementBadges(student, stats) {
    var badges = [];
    var grades = student.grades;
    var gradeKeys = Object.keys(grades);
    
    if (!stats) return badges;
    
    // 점수와 등급 데이터 준비
    var scores = [];
    var gradeValues = [];
    var subjectScores = {};
    var subjectRatios = {}; // ✅ 여기서 초기화
    
    gradeKeys.forEach(function(testName) {
        var gradeData = grades[testName];
        if (gradeData.score) scores.push(parseInt(gradeData.score));
        if (gradeData.grade) gradeValues.push(parseInt(gradeData.grade));
        
        // 과목별 점수 수집
        if (gradeData.details) {
            Object.keys(gradeData.details).forEach(function(subject) {
                if (!subjectScores[subject]) subjectScores[subject] = [];
                subjectScores[subject].push(gradeData.details[subject]);
            });
        }
        
        // ✅ 과목별 비율 수집 추가
        if (gradeData.ratios) {
            Object.keys(gradeData.ratios).forEach(function(subject) {
                if (!subjectRatios[subject]) subjectRatios[subject] = [];
                subjectRatios[subject].push(gradeData.ratios[subject]);
            });
        }
    });
    
    // 연속 상승/하락 체크
    var consecutiveUp = 0;
    var consecutiveDown = 0;
    var maxConsecutiveUp = 0;
    var maxConsecutiveDown = 0;
    
    for (var i = 1; i < scores.length; i++) {
        if (scores[i] > scores[i-1]) {
            consecutiveUp++;
            consecutiveDown = 0;
            maxConsecutiveUp = Math.max(maxConsecutiveUp, consecutiveUp);
        } else if (scores[i] < scores[i-1]) {
            consecutiveDown++;
            consecutiveUp = 0;
            maxConsecutiveDown = Math.max(maxConsecutiveDown, consecutiveDown);
        } else {
            consecutiveUp = 0;
            consecutiveDown = 0;
        }
    }
    
    // 과목별 강점 체크
    var strongSubjects = 0;
    var excellentSubjects = 0;
    Object.keys(subjectScores).forEach(function(subject) {
        var avg = subjectScores[subject].reduce((a, b) => a + b) / subjectScores[subject].length;
        if (avg >= 80) strongSubjects++;
        if (avg >= 90) excellentSubjects++;
    });
    
// 🏆 뱃지 조건 체크 (43개 뱃지, 중복 가능)

// 1. 등급 관련 뱃지 (5개)
if (stats.bestGrade === 1) {
    badges.push({ icon: "👑", text: "1등급 달성", type: "grade", isNew: true });
}
if (stats.bestGrade <= 2) {
    badges.push({ icon: "🏆", text: "상위등급 달성", type: "grade", isNew: false });
}
if (stats.bestGrade <= 3) {
    badges.push({ icon: "🥉", text: "3등급 이내", type: "grade", isNew: false });
}
if (stats.avgGrade <= 2.5) {
    badges.push({ icon: "🎪", text: "우수한 등급", type: "grade", isNew: false });
}
if (stats.avgGrade <= 1.5) {
    badges.push({ icon: "🎖️", text: "최상위 등급", type: "grade", isNew: true });
}

// 2. 점수 관련 뱃지 (4개)
if (stats.bestScore >= 95) {
    badges.push({ icon: "💎", text: "95점 이상", type: "score", isNew: true });
}
if (stats.avgScore >= 85) {
    badges.push({ icon: "🌟", text: "고득점자", type: "score", isNew: false });
}
if (stats.bestScore >= 100) {
    badges.push({ icon: "🎯", text: "만점 달성", type: "score", isNew: true });
}
if (stats.avgScore >= 90) {
    badges.push({ icon: "✨", text: "우수한 평균", type: "score", isNew: false });
}

// 3. 성적 변화 뱃지 (3개)
if (maxConsecutiveUp >= 2) {
    badges.push({ icon: "🔥", text: "연속 상승", type: "trend", isNew: true });
}
if (maxConsecutiveUp >= 3) {
    badges.push({ icon: "🚀", text: "3연속 상승", type: "trend", isNew: true });
}
if (maxConsecutiveUp >= 4) {
    badges.push({ icon: "🌪️", text: "4연속 폭풍 상승", type: "trend", isNew: true });
}

// 4. 점수 개선 뱃지 (3개) - 최근 변화량
if (stats.scoreChange >= 15) {
    badges.push({ icon: "📈", text: "대폭 상승", type: "improvement", isNew: true });
}
if (stats.scoreChange >= 25) {
    badges.push({ icon: "⚡", text: "폭발적 상승", type: "improvement", isNew: true });
}
if (stats.scoreChange >= 35) {
    badges.push({ icon: "🎆", text: "기적의 상승", type: "improvement", isNew: true });
}

// 5. 출석 및 성실성 뱃지 (3개)
if (stats.testCount >= 5) {
    badges.push({ icon: "⭐", text: "성실한 응시", type: "attendance", isNew: false });
}
if (stats.testCount >= 8) {
    badges.push({ icon: "💪", text: "꾸준한 도전", type: "attendance", isNew: false });
}
if (stats.testCount === stats.totalTests) {
    badges.push({ icon: "🏅", text: "완벽한 출석", type: "attendance", isNew: true });
}

// 7. 안정성 뱃지 (2개)
if (scores.length >= 3) {
    var scoreVariance = calculateVariance(scores);
    if (scoreVariance < 50) {
        badges.push({ icon: "🛡️", text: "안정적 성취", type: "stability", isNew: false });
    }
    if (scoreVariance < 25) {
        badges.push({ icon: "🏰", text: "완벽한 안정", type: "stability", isNew: true });
    }
}

// 1등급 마스터 뱃지 (등급 관련 뱃지 섹션에 추가)
    var consecutiveGrade1 = 0;
    var maxConsecutiveGrade1 = 0;
    for (var i = 0; i < gradeValues.length; i++) {
        if (gradeValues[i] === 1) {
            consecutiveGrade1++;
            maxConsecutiveGrade1 = Math.max(maxConsecutiveGrade1, consecutiveGrade1);
        } else {
            consecutiveGrade1 = 0;
        }
    }
    
    if (maxConsecutiveGrade1 >= 5) {
        badges.push({ icon: "👑", text: "1등급 마스터", type: "grade", isNew: true });
    }

// 9. 회복/성장 뱃지 (2개)
if (maxConsecutiveDown >= 2 && consecutiveUp >= 2) {
    badges.push({ icon: "🔄", text: "극적 회복", type: "recovery", isNew: true });
}
if (scores.length >= 5 && scores[scores.length-1] > scores[0] + 20) {
    badges.push({ icon: "📊", text: "장기 성장", type: "recovery", isNew: false });
}

// ========== 🆕 새로 추가된 뱃지들 ==========

// 10. 한 번의 큰 점프 뱃지 (3개)
var maxSingleJump = 0;
if (scores.length >= 2) {
    for (var i = 1; i < scores.length; i++) {
        var jump = scores[i] - scores[i-1];
        maxSingleJump = Math.max(maxSingleJump, jump);
    }
    
    // 한 번의 큰 점프 뱃지
    if (maxSingleJump >= 35) {
        badges.push({ icon: "🌈", text: "놀라운 점프", type: "single-jump", isNew: true });
    }
    if (maxSingleJump >= 25) {
        badges.push({ icon: "🎢", text: "큰 도약", type: "single-jump", isNew: false });
    }
    if (maxSingleJump >= 15) {
        badges.push({ icon: "📍", text: "성공적 점프", type: "single-jump", isNew: false });
    }
}

// 11. 전체 성장 뱃지 (2개)
if (scores.length >= 3) {
    // 역전 스토리 뱃지 (한번 많이 떨어졌다가 다시 올라온 경우)
    var minScore = Math.min(...scores);
    var maxScore = Math.max(...scores);
    var minIndex = scores.indexOf(minScore);
    var maxIndex = scores.lastIndexOf(maxScore);
    
    if (minIndex < maxIndex && (maxScore - minScore) >= 40) {
        badges.push({ icon: "🔄", text: "역전의 스토리", type: "total-growth", isNew: true });
    }
    
    // 안정적 상승 (전체적으로 꾸준히 오름)
    var upwardCount = 0;
    for (var i = 1; i < scores.length; i++) {
        if (scores[i] >= scores[i-1]) upwardCount++;
    }
    var upwardRatio = upwardCount / (scores.length - 1);
    
    var firstScore = scores[0];
    var lastScore = scores[scores.length - 1];
    var totalChange = lastScore - firstScore;
    
    if (upwardRatio >= 0.8 && totalChange >= 15) {
        badges.push({ icon: "🚀", text: "꾸준한 상승세", type: "total-growth", isNew: false });
    }
}

   // 12. 과목별 마스터 뱃지 (9개 + 3개 종합)
    var subjectMasters = [];
    
    var koreanSubjects = [
        '독서(인문 이론)', '독서(사회)', '독서(과학)',
        '문학(현대시)', '문학(현대소설)', '문학(고전시가)', '문학(고전소설)',
        '언어 화법', '매체 작문'
    ];
    
    koreanSubjects.forEach(function(targetSubject) {
        var subjectMapping = {
            '독서(인문 이론)': ['독서(인문 이론)', '독서(인문이론)', '독서인문', '인문'],
            '독서(사회)': ['독서(사회)', '독서사회', '사회'],
            '독서(과학)': ['독서(과학)', '독서과학', '과학'],
            '문학(현대시)': ['문학(현대시)', '문학현대시', '현대시', '현시'],
            '문학(현대소설)': ['문학(현대소설)', '문학현대소설', '현대소설', '현소'],
            '문학(고전시가)': ['문학(고전시가)', '문학고전시가', '고전시가', '고시'],
            '문학(고전소설)': ['문학(고전소설)', '문학고전소설', '고전소설', '고소'],
            '언어 화법': ['언어 화법', '언어화법', '화법'],
            '매체 작문': ['매체 작문', '매체작문', '작문']
        };
        
        var possibleNames = subjectMapping[targetSubject] || [targetSubject];
        var matchedSubject = null;
        
        for (var actualSubject in subjectRatios) {
            for (var i = 0; i < possibleNames.length; i++) {
                if (actualSubject === possibleNames[i] || 
                    actualSubject.includes(possibleNames[i]) || 
                    possibleNames[i].includes(actualSubject)) {
                    matchedSubject = actualSubject;
                    break;
                }
            }
            if (matchedSubject) break;
        }
        
        if (matchedSubject && subjectRatios[matchedSubject]) {
        var ratios = subjectRatios[matchedSubject];
        
        // 전체 시험 중 연속된 4회 100% 달성 여부 체크
        var hasConsecutive4Perfect = false;
        
        if (ratios.length >= 4) {
            for (var i = 0; i <= ratios.length - 4; i++) {
                var consecutive4 = ratios.slice(i, i + 4);
                if (consecutive4.every(ratio => ratio >= 100)) {
                    hasConsecutive4Perfect = true;
                    break;
                }
            }
        }
        
        if (hasConsecutive4Perfect) {
            badges.push({ 
                icon: "🏆", 
                text: targetSubject + " 마스터", 
                type: "subject-master", 
                isNew: true 
            });
            subjectMasters.push(targetSubject);
        }
    }
    });
    
    // 13. 종합 뱃지 (3개)
    if (subjectMasters.length >= 3) {
        badges.push({ icon: "🎓", text: "국어 올라운더", type: "subject-master", isNew: true });
    }
    if (subjectMasters.length >= 5) {
        badges.push({ icon: "📚", text: "국어 마에스트로", type: "subject-master", isNew: true });
    }
    if (subjectMasters.length >= 9) {
        badges.push({ icon: "👑", text: "국어 레전더리", type: "subject-master", isNew: true });
    }
    
    // 
    return badges;
}

        // 뱃지 설명 데이터
var badgeDescriptions = {
    // 등급 관련 뱃지
    "1등급 달성": "국어 모의고사에서 최고 등급인 1등급을 달성했습니다! 상위 4% 안에 드는 뛰어난 성취입니다.",
    "상위등급 달성": "2등급 이상의 상위 등급을 달성했습니다. 꾸준한 노력의 결과입니다!",
    "3등급 이내": "3등급 이내의 준수한 성적을 기록했습니다. 상위권 진입의 발판이 되었네요!",
    "우수한 등급": "평균 2.5등급 이상의 우수한 성적을 유지하고 있습니다.",
    "최상위 등급": "평균 1.5등급 이상! 최상위권 학생의 증거입니다.",
    
    // 점수 관련 뱃지
    "95점 이상": "95점 이상의 고득점을 달성했습니다! 거의 만점에 가까운 실력이네요.",
    "고득점자": "평균 85점 이상의 안정적인 고득점을 유지하고 있습니다.",
    "만점 달성": "100점 만점을 달성했습니다! 완벽한 실력을 보여주었네요.",
    "우수한 평균": "평균 90점 이상의 뛰어난 실력을 보여주고 있습니다.",
    
    // 성적 변화 뱃지
    "연속 상승": "2회 연속으로 성적이 상승했습니다. 꾸준한 발전이 돋보입니다!",
    "3연속 상승": "3회 연속 상승! 지속적인 성장 곡선을 그리고 있습니다.",
    "4연속 폭풍 상승": "4회 연속 상승의 놀라운 기록! 멈출 수 없는 상승세입니다.",
    
    // 점수 개선 뱃지
    "대폭 상승": "이전 시험 대비 15점 이상 상승했습니다. 큰 발전이네요!",
    "폭발적 상승": "25점 이상의 폭발적인 상승을 기록했습니다!",
    "기적의 상승": "35점 이상의 기적 같은 상승! 놀라운 발전입니다.",
    
    // 출석 및 성실성 뱃지
    "성실한 응시": "5회 이상의 모의고사에 성실하게 참여했습니다.",
    "꾸준한 도전": "8회 이상 꾸준히 모의고사에 도전하는 성실함을 보였습니다.",
    "완벽한 출석": "모든 모의고사에 빠짐없이 참여했습니다. 성실성의 상징!",
    
                   
    // 안정성 뱃지
    "안정적 성취": "성적의 편차가 적어 안정적인 실력을 보여주고 있습니다.",
    "완벽한 안정": "매우 안정적인 성적 유지! 실력이 확고히 자리잡았습니다.",
    
   // 등급 관련 뱃지 섹션에 추가
    "1등급 마스터": "1등급을 5회 연속으로 달성한 진정한 최상위권 학생입니다! 꾸준함과 실력을 모두 갖춘 마스터입니다.",
    
    // 회복/성장 뱃지
    "극적 회복": "연속 하락 후 극적으로 회복한 드라마틱한 스토리를 만들었습니다!",
    "장기 성장": "장기간에 걸쳐 20점 이상의 꾸준한 성장을 보였습니다.",
    
    // 한번의 큰 점프 뱃지
    "놀라운 점프": "한 번에 35점 이상의 놀라운 점수 향상을 이뤘습니다!",
    "큰 도약": "25점 이상의 큰 도약을 해냈습니다!",
    "성공적 점프": "15점 이상의 성공적인 점수 향상을 기록했습니다.",
    
    // 전체 성장 뱃지
    "역전의 스토리": "최저점에서 최고점까지, 감동적인 역전 드라마를 써냈습니다!",
    "꾸준한 상승세": "전체적으로 꾸준한 상승세를 보이며 성장하고 있습니다.",
    
    // 고3 과목별 마스터 뱃지
    "독서(인문 이론) 마스터": "독서(인문 이론) 영역에서 최근 4회 연속 만점! 완벽한 마스터입니다.",
    "독서(사회) 마스터": "독서(사회) 영역 최근 4회 연속 만점! 사회 현상 이해력이 우수합니다.",
    "독서(과학) 마스터": "독서(과학) 영역 최근 4회 연속 만점! 과학적 사고력이 탁월합니다.",
    "문학(현대시) 마스터": "현대시 영역 최근 4회 연속 만점! 시적 감수성이 뛰어납니다.",
    "문학(현대소설) 마스터": "현대소설 영역 최근 4회 연속 만점! 서사 이해력이 완벽합니다.",
    "문학(고전시가) 마스터": "고전시가 영역 최근 4회 연속 만점! 고전 문학의 진수를 이해했습니다.",
    "문학(고전소설) 마스터": "고전소설 영역 최근 4회 연속 만점! 고전 서사의 대가입니다.",
    "언어 화법 마스터": "언어 화법 영역에서 최근 4회 연속 만점! 의사소통의 달인입니다.",
    "매체 작문 마스터": "매체 작문 영역에서 최근 4회 연속 만점! 현대적 소통의 전문가입니다.",
    
    // 종합 뱃지
    "국어 올라운더": "3개 이상의 과목에서 마스터 달성! 국어의 다양한 영역에 능통합니다.",
    "국어 마에스트로": "5개 이상의 과목에서 마스터 달성! 국어 실력이 대가 수준입니다.",
    "국어 레전더리": "모든 9개 과목에서 마스터 달성! 국어계의 전설이 되었습니다!"
};

        // 툴팁 관리 변수
var currentTooltip = null;
var tooltipTimeout = null;

// 뱃지 툴팁 표시 함수
function showBadgeTooltip(event, badgeText) {
    console.log('툴팁 표시 시도:', badgeText);
    
    // 기존 툴팁 제거
    hideBadgeTooltip();
    
    var description = badgeDescriptions[badgeText];
    if (!description) {
        console.log('설명을 찾을 수 없음:', badgeText);
        return;
    }
    
    console.log('툴팁 생성 중:', description);
    
    // 툴팁 생성
    var tooltip = document.createElement('div');
    tooltip.className = 'badge-tooltip';
    tooltip.innerHTML = '<strong>' + badgeText + '</strong><br>' + description;
    document.body.appendChild(tooltip);
    
    // 모바일 체크
    var isMobile = window.innerWidth <= 768;
    console.log('isMobile:', isMobile);
    

    // 간단한 위치 설정
    var rect = event.target.getBoundingClientRect();
    tooltip.style.left = (rect.left + rect.width / 2) + 'px';
    tooltip.style.top = (rect.top - 10) + 'px';
    tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
    
    // 애니메이션으로 표시
    requestAnimationFrame(function() {
        tooltip.classList.add('visible');
    });
    
    currentTooltip = tooltip;
    
    // 모바일에서는 3초 후 자동 숨김
    if (isMobile) {
        tooltipTimeout = setTimeout(hideBadgeTooltip, 3000);
    }
    
    console.log('툴팁 표시 완료');
}

// 뱃지 툴팁 숨김 함수
function hideBadgeTooltip() {
    if (currentTooltip) {
        currentTooltip.classList.remove('visible');
        setTimeout(function() {
            if (currentTooltip && currentTooltip.parentNode) {
                currentTooltip.parentNode.removeChild(currentTooltip);
            }
            currentTooltip = null;
        }, 300);
    }
    
    if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
    }
}

// 뱃지에 이벤트 리스너 추가하는 함수
function addBadgeTooltipEvents() {
    var badges = document.querySelectorAll('.achievement-badge');
    console.log('뱃지 툴팁 이벤트 설정 중... 발견된 뱃지 수:', badges.length);
    
    badges.forEach(function(badge, index) {
        // 기존 이벤트 리스너 제거
        badge.removeEventListener('mouseenter', badge._mouseenterHandler);
        badge.removeEventListener('mouseleave', badge._mouseleaveHandler);
        badge.removeEventListener('click', badge._clickHandler);
        
        // 더 안전한 텍스트 추출 방법
        var badgeText = '';
        var textNodes = [];
        
        // 모든 텍스트 노드 수집
        function collectTextNodes(node) {
            if (node.nodeType === 3) { // TEXT_NODE
                textNodes.push(node.nodeValue);
            } else {
                for (var i = 0; i < node.childNodes.length; i++) {
                    collectTextNodes(node.childNodes[i]);
                }
            }
        }
        
        collectTextNodes(badge);
        badgeText = textNodes.join(' ')
            .replace('NEW!', '')
            .replace(/\s+/g, ' ')
            .trim();
        
        console.log('뱃지 설정:', index, '"' + badgeText + '"');
        
        // 모바일: 클릭 이벤트
        badge._clickHandler = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('뱃지 클릭:', '"' + badgeText + '"');
            
            if (currentTooltip) {
                hideBadgeTooltip();
            } else {
                showBadgeTooltip(e, badgeText);
            }
        };
        
        badge.addEventListener('click', badge._clickHandler);
    });
}

// 전역 클릭 이벤트로 툴팁 숨김 (모바일)
document.addEventListener('click', function(e) {
    // 뱃지나 툴팁을 클릭한 경우가 아니라면 툴팁 숨김
    if (currentTooltip && 
        !e.target.classList.contains('achievement-badge') && 
        !e.target.closest('.achievement-badge') &&
        !e.target.closest('.badge-tooltip')) {
        hideBadgeTooltip();
    }
});
        
        // 📅 D-day 계산
        function calculateDday() {
            var today = new Date();
            
            // 고2/고3 구분 (페이지 제목으로 판단)
            var isGrade3 = document.title.includes('고3');
            
            var examDate;
            if (isGrade3) {
                examDate = new Date('2025-11-13'); // 고3: 25년 11.13.(목)
            } else {
                examDate = new Date('2026-11-19'); // 고2: 26년 11.19.(목)
            }
            
            var diffTime = examDate - today;
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return {
                days: diffDays,
                examDate: examDate,
                isGrade3: isGrade3
            };
        }
        
        // 📈 성적 그래프 생성
        function createGradeChart(student) {
            var grades = student.grades;
            var gradeKeys = Object.keys(grades);
            
            if (gradeKeys.length < 2) return null;
            
            var labels = [];
            var scoreData = [];
            var gradeData = [];
            
            gradeKeys.forEach(function(testName) {
                var gradeInfo = grades[testName];
                labels.push(testName);
                scoreData.push(gradeInfo.score || 0);
                gradeData.push(gradeInfo.grade || 9);
            });
            
            return {
                labels: labels,
                datasets: [
                    {
                        label: '점수',
                        data: scoreData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: '등급',
                        data: gradeData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            };
        }
        
        // 통합 대시보드 표시 함수
        function displayDashboard(student) {
            var stats = calculateStatistics(student);
            var badges = generateAchievementBadges(student, stats);
            var dday = calculateDday();
            
            if (!stats) return '';
            
            var changeIcon = stats.scoreChange > 0 ? '📈' : stats.scoreChange < 0 ? '📉' : '➡️';
            var changeClass = stats.scoreChange > 0 ? 'stat-positive' : stats.scoreChange < 0 ? 'stat-negative' : 'stat-neutral';
            var changeText = stats.scoreChange > 0 ? '+' + stats.scoreChange : stats.scoreChange;
            
            return `
                <!-- D-day 카운터 -->
                <div class="dday-counter">
                    <div class="dday-text">${dday.isGrade3 ? '🎯 수능' : '📚 수능'}까지</div>
                    <div class="dday-number">D-${dday.days}</div>
                    <div style="font-size: 1em; opacity: 0.9;">
                        ${dday.examDate.toLocaleDateString('ko-KR', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'})}
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <!-- 📊 통계 대시보드 -->
                    <div class="dashboard-card">
                        <h3>📊 성적 통계</h3>
                        <div class="stat-item">
                            <span class="stat-label">평균 점수</span>
                            <span class="stat-value">${stats.avgScore}점</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">평균 등급</span>
                            <span class="stat-value">${stats.avgGrade}등급</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">최고 성적</span>
                            <span class="stat-value">${stats.bestGrade}등급 ${stats.bestScore}점</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">최근 변화</span>
                            <span class="stat-value ${changeClass}">${changeIcon} ${changeText}점</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">예상 순위</span>
                            <span class="stat-value">상위 ${stats.percentile}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">응시율</span>
                            <span class="stat-value">${Math.round(stats.testCount/stats.totalTests*100)}% (${stats.testCount}/${stats.totalTests}회)</span>
                        </div>
                    </div>
                    
                    <!-- 🏆 성취 뱃지 -->
<div class="dashboard-card">
    <h3>🏆 성취 뱃지 <span style="font-size: 0.8em; color: #667eea;">(${badges.length}/40개 획득)</span></h3>
    
  
${badges.length >= 25 ? 
`<div style="
    background: linear-gradient(135deg, #ffd700, #ff8c00); 
    color: white; 
    border-radius: 15px; 
    padding: 20px; 
    margin: 15px 0; 
    text-align: center; 
    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
    animation: grand-master-glow 2s infinite alternate;
">
    <div style="font-size: 2em; margin-bottom: 10px;">🎊👑🎊</div>
    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
        축하합니다! 25개 이상의 뱃지를 모아<br>
        국어 그랜드 마스터가 되었습니다! 🏆
    </div>
    <div style="font-size: 1.1em; opacity: 0.95;">
        이대건T에게 가서 선물을 수령하세요! 🎁
    </div>
</div>` : 
''
}

${badges.length > 0 ? 
    '<div class="badge-summary">총 ' + badges.length + '/40개의 뱃지를 획득했습니다!' + 
    (badges.length >= 35 ? ' 🔥 사랑한다 제자야. 고생많았어.!' : 
     badges.length >= 30 ? ' 🌟 거의 다 모았어요!' : 
     badges.length >= 25 ? ' 🎉 국어 그랜드 마스터 달성!' : 
     badges.length >= 15 ? ' 💪 많이 모았네요!' : '') + '</div>' +
        '<div class="badge-container">' +
        badges.map(badge => 
           `<div class="achievement-badge ${badge.type} ${badge.isNew ? 'badge-new' : ''}">
                <span>${badge.icon}</span>
                <span>${badge.text}</span>
                ${badge.isNew ? '<span style="font-size: 0.7em;">NEW!</span>' : ''}
            </div>`
        ).join('') +
        '</div>' :
    '<p style="color: #666; text-align: center; padding: 20px;">더 많은 시험을 치르면 뱃지를 획득할 수 있어요!</p>'
    }
    
    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.85em; text-align: center;">
        💡 <strong>PC:</strong> 뱃지를 클릭하면 설명을 볼 수 있어요!<br>
        📱 <strong>모바일:</strong> 뱃지를 터치하면 설명이 나타납니다!
    </div>
</div>
                
                <!-- 📈 성적 변화 그래프 -->
                <div class="dashboard-card" style="margin: 25px 0;">
                    <h3>📈 성적 변화 추이</h3>
                    <div class="chart-container">
                        <canvas id="gradeChart_${student.attendanceNumber}"></canvas>
                    </div>
                </div>
            `;
        }
        
        // Chart.js 그래프 생성
        function createChart(student) {
            var chartData = createGradeChart(student);
            if (!chartData) return;
            
            var ctx = document.getElementById('gradeChart_' + student.attendanceNumber);
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '점수'
                            },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '등급'
                            },
                            min: 1,
                            max: 9,
                            reverse: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        var studentByNumber = {};
        var isDataLoaded = false;
        var githubConfig = {};
        var dataUrl = '';
        var isAdminAuthenticated = false;
        
        var maxScores = {}; // 하드코딩된 값 제거, 엑셀에서 추출한 값만 사용
        var gradeCutData = {}; // 고3 전용: 등급컷 데이터
        
        // 분석 함수
        function generateAIAnalysis(student) {
            console.log('분석 시작:', student.name);
            
            // 분석 섹션 표시
            var aiAnalysisDiv = document.getElementById('aiAnalysis');
            var aiContentDiv = document.getElementById('aiContent');
            
            aiAnalysisDiv.style.display = 'block';
            
            // 로딩 상태 표시
            aiContentDiv.innerHTML = `
                <div class="ai-loading">
                    <span>🧠 성적을 분석하고 있습니다</span>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            
            // 실제 분석 실행 (시뮬레이션)
setTimeout(function() {
    var analysis = performAIAnalysis(student);
    displayAIAnalysis(analysis);
    
    // AI 분석 완료 후 학습 계획서 자동 생성
    setTimeout(function() {
        generateAutoStudyPlan(student);
    }, 1000);
}, 2000); // 2초 후 분석 결과 표시
        }
        
        function performAIAnalysis(student) {
            var grades = student.grades;
            var gradeKeys = Object.keys(grades);
            
            if (gradeKeys.length === 0) {
                return {
                    summary: "분석할 성적 데이터가 부족합니다.",
                    strengths: [],
                    weaknesses: [],
                    trends: [],
                    recommendations: [],
                    gradeStrategy: null
                };
            }
            
            // 등급 및 점수 분석
            var gradeValues = [];
            var scoreValues = [];
            var subjectScores = {};
            var subjectRatios = {};
            var testDetails = {}; // 시험별 상세 정보 저장
            
            gradeKeys.forEach(function(testName) {
                var gradeData = grades[testName];
                if (gradeData.grade) gradeValues.push(parseInt(gradeData.grade));
                if (gradeData.score) scoreValues.push(parseInt(gradeData.score));
                
                // 시험별 상세 정보 저장 (최고 성적 찾기용)
                testDetails[testName] = {
                    grade: parseInt(gradeData.grade),
                    score: parseInt(gradeData.score),
                    source: gradeData.source || '',
                    subjectType: gradeData.subjectType || ''
                };
                
                // 과목별 점수 및 비율 수집
                if (gradeData.details) {
                    Object.keys(gradeData.details).forEach(function(subject) {
                        if (!subjectScores[subject]) subjectScores[subject] = [];
                        if (!subjectRatios[subject]) subjectRatios[subject] = [];
                        
                        subjectScores[subject].push(gradeData.details[subject]);
                        if (gradeData.ratios && gradeData.ratios[subject]) {
                            subjectRatios[subject].push(gradeData.ratios[subject]);
                        }
                    });
                }
            });
            
            // 통계 계산
            var avgGrade = gradeValues.length > 0 ? Math.round(gradeValues.reduce((a, b) => a + b) / gradeValues.length * 10) / 10 : 0;
            var avgScore = scoreValues.length > 0 ? Math.round(scoreValues.reduce((a, b) => a + b) / scoreValues.length) : 0;
            var bestGrade = gradeValues.length > 0 ? Math.min(...gradeValues) : 0;
            var bestScore = scoreValues.length > 0 ? Math.max(...scoreValues) : 0;
            var latestGrade = gradeValues.length > 0 ? gradeValues[gradeValues.length - 1] : 0;
            
            // 최고 성적 시험 찾기
            var bestTest = '';
            var bestTestSource = '';
            var bestTestSubjectType = '';
            Object.keys(testDetails).forEach(function(testName) {
                var testInfo = testDetails[testName];
                if (testInfo.score === bestScore) {
                    bestTest = testName;
                    bestTestSource = testInfo.source;
                    bestTestSubjectType = testInfo.subjectType;
                }
            });
            
            // 과목별 평균 계산
            var subjectAverages = {};
            Object.keys(subjectRatios).forEach(function(subject) {
                var ratios = subjectRatios[subject];
                if (ratios.length > 0) {
                    subjectAverages[subject] = Math.round(ratios.reduce((a, b) => a + b) / ratios.length * 10) / 10;
                }
            });
            
            // 강점 과목 찾기 (평균 70% 이상)
            var strengths = [];
            Object.keys(subjectAverages).forEach(function(subject) {
                if (subjectAverages[subject] >= 70) {
                    strengths.push({
                        subject: subject,
                        average: subjectAverages[subject]
                    });
                }
            });
            strengths.sort((a, b) => b.average - a.average);
            
            // 개선 필요 과목 분석 (기존 + 다층 분석)
            var weaknesses = analyzeWeaknesses(subjectRatios, subjectAverages);
            
            // 성적 추이 분석 (하이브리드 접근법)
            var trends = [];
            Object.keys(subjectRatios).forEach(function(subject) {
                var ratios = subjectRatios[subject];
                if (ratios.length >= 3) {
                    var hybridResult = calculateHybridTrend(ratios);
                    
                    if (hybridResult && Math.abs(hybridResult.shortTermTrend) > 5) {
                        trends.push({
                            subject: subject,
                            shortTermTrend: hybridResult.shortTermTrend,
                            stability: hybridResult.stability,
                            pattern: hybridResult.pattern,
                            type: hybridResult.shortTermTrend > 0 ? 'up' : 'down',
                            intensity: getIntensityDescription(hybridResult.shortTermTrend)
                        });
                    }
                }
            });
            
            // 추천사항 생성
            var recommendations = [];
            
            if (weaknesses.length > 0) {
                recommendations.push({
                    priority: "높음",
                    action: weaknesses[0].subject + " 집중 학습",
                    reason: weaknesses[0].description
                });
            }
            
            if (bestGrade <= 2 && latestGrade > bestGrade) {
                recommendations.push({
                    priority: "중간",
                    action: "최고 성적 회복을 위한 전략 수립",
                    reason: "최고 " + bestGrade + "등급에서 현재 " + latestGrade + "등급으로 하락"
                });
            }
            
            if (trends.filter(t => t.type === 'up').length > 0) {
                var upTrend = trends.filter(t => t.type === 'up').sort((a, b) => b.shortTermTrend - a.shortTermTrend)[0];
                recommendations.push({
                    priority: "낮음",
                    action: upTrend.subject + " 상승세 유지",
                    reason: upTrend.intensity + " 향상 추세"
                });
            }
            
            // 구체적 등급 상승 전략 생성
            var gradeStrategy = generateGradeStrategy(student, gradeKeys, subjectRatios, subjectAverages);
            
            return {
                summary: {
                    name: student.name,
                    attendanceNumber: student.attendanceNumber,
                    testCount: gradeKeys.length,
                    totalTests: window.discoveredTestSheets ? window.discoveredTestSheets.length : 12,
                    avgGrade: avgGrade,
                    avgScore: avgScore,
                    bestGrade: bestGrade,
                    bestScore: bestScore,
                    bestTest: bestTest,
                    bestTestSource: bestTestSource,
                    bestTestSubjectType: bestTestSubjectType,
                    latestGrade: latestGrade
                },
                strengths: strengths.slice(0, 3),
                weaknesses: weaknesses.slice(0, 3),
                trends: trends,
                recommendations: recommendations,
                gradeStrategy: gradeStrategy
            };
        }
        
        // 구체적 등급 상승 전략 생성 함수
        function generateGradeStrategy(student, gradeKeys, subjectRatios, subjectAverages) {
            if (gradeKeys.length < 2) return null;
            
            // 최근 4회 시험 데이터 추출
            var recentTests = gradeKeys.slice(-4);
            var recentData = [];
            
            recentTests.forEach(function(testName) {
                var gradeData = student.grades[testName];
                if (gradeData) {
                    recentData.push({
                    name: testName,
                    grade: parseInt(gradeData.grade),
                    score: parseInt(gradeData.score),
                    subjectType: gradeData.subjectType || ''
                });
                }
            });
            
            if (recentData.length < 2) return null;
            
            // 최근 4회 평균 계산
            var recentAvgGrade = Math.round(recentData.reduce((sum, test) => sum + test.grade, 0) / recentData.length * 10) / 10;
            var recentAvgScore = Math.round(recentData.reduce((sum, test) => sum + test.score, 0) / recentData.length);
            
            // 목표 등급 설정 (현재 평균보다 한 등급 위)
            var targetGrade = Math.max(1, Math.floor(recentAvgGrade));
            var targetScore = getTargetScore(targetGrade);
            var neededPoints = targetScore - recentAvgScore;
            
            // 달성 가능성 평가
            var possibility = 'medium';
            if (neededPoints <= 5) possibility = 'high';
            else if (neededPoints > 15) possibility = 'low';
            
            // 과목별 점수 확보 전략
            var subjectStrategies = [];
            var totalPossibleGain = 0;
            
            Object.keys(subjectAverages).forEach(function(subject) {
                var avg = subjectAverages[subject];
                var recent4Ratios = subjectRatios[subject] ? subjectRatios[subject].slice(-4) : [];
                
                if (recent4Ratios.length === 0) return;
                
                var recent4Avg = recent4Ratios.reduce((a, b) => a + b) / recent4Ratios.length;
                var maxRatio = Math.max(...recent4Ratios);
                var potential = Math.max(0, maxRatio - recent4Avg);
                
                var strategy = '';
                var strategyColor = '';
                var possibleGain = 0;
                
                if (recent4Avg < 60) {
                    strategy = '기본기 보강 필요';
                    strategyColor = '#ef4444'; // 빨간색
                    possibleGain = Math.min(4, potential * 0.2); // 20% 성취도 향상 = 약 4점
                } else if (recent4Avg < 80) {
                    strategy = '안정화 필요';
                    strategyColor = '#f59e0b'; // 주황색
                    possibleGain = Math.min(3, potential * 0.15);
                } else if (recent4Avg < 95) {
                    strategy = '실수 방지 집중';
                    strategyColor = '#10b981'; // 녹색
                    possibleGain = Math.min(2, potential * 0.1);
                } else {
                    strategy = '현재 수준 유지';
                    strategyColor = '#6366f1'; // 보라색
                    possibleGain = 1;
                }
                
                if (possibleGain > 0.5) {
                    console.log('과목별 점수 확보:', subject, possibleGain + '점');
                    subjectStrategies.push({
                        subject: subject,
                        currentAvg: Math.round(recent4Avg),
                        strategy: strategy,
                        strategyColor: strategyColor,
                        possibleGain: Math.round(possibleGain * 10) / 10
                    });
                    totalPossibleGain += possibleGain;
                    console.log('누적 총합:', totalPossibleGain);
                }
            });
            
            console.log('최종 계산 결과:', totalPossibleGain);
            console.log('표시될 값:', Math.round(totalPossibleGain * 10) / 10);
            
            // 가능성 재평가
            if (totalPossibleGain >= neededPoints * 1.2) possibility = 'high';
            else if (totalPossibleGain < neededPoints * 0.8) possibility = 'low';
            
            subjectStrategies.sort((a, b) => b.possibleGain - a.possibleGain);

            // 상위 4과목만 선택
            var top4Strategies = subjectStrategies.slice(0, 4);
            
            // 상위 4과목의 점수만 합산
            var top4TotalGain = 0;
            top4Strategies.forEach(function(strategy) {
                top4TotalGain += strategy.possibleGain;
            });
            
            console.log('상위 4과목 점수 확보 합계:', top4TotalGain);
            
            return {
                recentTests: recentData,
                recentAvgGrade: recentAvgGrade,
                recentAvgScore: recentAvgScore,
                targetGrade: targetGrade,
                targetScore: targetScore,
                neededPoints: neededPoints,
                possibility: possibility,
                subjectStrategies: top4Strategies,
                totalPossibleGain: Math.round(top4TotalGain * 10) / 10
            };
        }
        
        // 등급별 목표 점수 반환
        function getTargetScore(grade) {
            var scoreMap = {
                1: 90,
                2: 80,
                3: 70,
                4: 60,
                5: 50,
                6: 40
            };
            return scoreMap[grade] || 90;
        }
        
        // 다층 분석 방식으로 개선 필요 과목 찾기
        function analyzeWeaknesses(subjectRatios, subjectAverages) {
            var weaknesses = [];
            var studentAvg = Object.values(subjectAverages).reduce((a, b) => a + b, 0) / Object.values(subjectAverages).length;
            
            Object.keys(subjectRatios).forEach(function(subject) {
                var ratios = subjectRatios[subject];
                if (ratios.length === 0) return;
                
                // 최근 4회 데이터
                var recentRatios = ratios.slice(-4);
                var recentAvg = recentRatios.reduce((a, b) => a + b) / recentRatios.length;
                
                // 기존 방식: 최근 4회 평균 65% 미만
                var basicWeakness = recentAvg < 65;
                
                // 다층 분석 기준
                var criteria = {
                    absoluteLow: recentAvg < 50,                          // 절대적 저조
                    relativeLow: recentAvg < studentAvg * 0.8,            // 개인 평균 대비 저조 
                    declining: calculateSimpleTrend(ratios) < -10,        // 하락 추세
                    unstable: calculateStability(ratios) < 70             // 불안정
                };
                
                var criteriaCount = Object.values(criteria).filter(Boolean).length;
                var isMultiLayerWeakness = criteriaCount >= 1;  // 1개 이상 기준 충족
                
                if (basicWeakness || isMultiLayerWeakness) {
                    var description = '';
                    
                    if (basicWeakness) {
                        description = "최근 4회 평균 " + Math.round(recentAvg * 10) / 10 + "%로 기준점 미달";
                    } else {
                        var reasons = [];
                        if (criteria.absoluteLow) reasons.push("절대적 저조");
                        if (criteria.relativeLow) reasons.push("개인 평균 대비 저조");
                        if (criteria.declining) reasons.push("하락 추세");
                        if (criteria.unstable) reasons.push("성취도 불안정");
                        description = reasons.join(', ') + " (최근 4회: " + Math.round(recentAvg * 10) / 10 + "%)";
                    }
                    
                    weaknesses.push({
                        subject: subject,
                        average: Math.round(recentAvg * 10) / 10,
                        isBasicWeakness: basicWeakness,
                        isMultiLayerWeakness: isMultiLayerWeakness,
                        criteriaCount: criteriaCount,
                        description: description,
                        urgency: basicWeakness ? 'high' : criteriaCount >= 3 ? 'high' : 'medium'
                    });
                }
            });
            
            // 우선순위 정렬: 기존 방식 우선, 그 다음 다층 분석 점수
            weaknesses.sort((a, b) => {
                if (a.isBasicWeakness !== b.isBasicWeakness) {
                    return b.isBasicWeakness - a.isBasicWeakness;
                }
                return b.criteriaCount - a.criteriaCount;
            });
            
            return weaknesses;
        }
        
        // 하이브리드 추세 분석
        function calculateHybridTrend(ratios) {
            if (ratios.length < 4) return null;
            
            // 1. 최근 4회 vs 이전 데이터 비교
            var recent4 = ratios.slice(-4);
            var earlier = ratios.slice(0, -4);
            
            var recentAvg = recent4.reduce((a, b) => a + b) / recent4.length;
            var earlierAvg = earlier.length > 0 ? 
                earlier.reduce((a, b) => a + b) / earlier.length : recentAvg;
            
            var shortTermTrend = Math.round((recentAvg - earlierAvg) * 10) / 10;
            
            // 2. 최고점 대비 현재 위치
            var maxScore = Math.max(...ratios);
            var currentScore = ratios[ratios.length - 1];
            var peakMaintenance = Math.round((currentScore / maxScore) * 100);
            
            // 3. 안정성 계산
            var avg = ratios.reduce((a, b) => a + b) / ratios.length;
            var variance = ratios.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / ratios.length;
            var stability = Math.max(0, Math.round((100 - Math.sqrt(variance)) * 10) / 10);
            
            // 4. 패턴 인식
            var pattern = determinePattern(ratios);
            
            return {
                shortTermTrend: shortTermTrend,
                peakMaintenance: peakMaintenance,
                stability: stability,
                pattern: pattern
            };
        }
        
        // 간단한 추세 계산 (다층 분석용)
        function calculateSimpleTrend(ratios) {
            if (ratios.length < 3) return 0;
            var recent = ratios.slice(-3);
            var earlier = ratios.slice(0, -3);
            if (earlier.length === 0) return 0;
            
            var recentAvg = recent.reduce((a, b) => a + b) / recent.length;
            var earlierAvg = earlier.reduce((a, b) => a + b) / earlier.length;
            return recentAvg - earlierAvg;
        }
        
        // 안정성 계산
        function calculateStability(ratios) {
            var avg = ratios.reduce((a, b) => a + b) / ratios.length;
            var variance = ratios.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / ratios.length;
            return Math.max(0, 100 - Math.sqrt(variance));
        }
        
        // 패턴 결정
        function determinePattern(ratios) {
            var improvements = 0;
            var declines = 0;
            
            for (var i = 1; i < ratios.length; i++) {
                var change = ratios[i] - ratios[i-1];
                if (change > 3) improvements++;
                else if (change < -3) declines++;
            }
            
            if (improvements > declines) return 'improving';
            else if (declines > improvements) return 'declining';
            else return 'stable';
        }
        
        // 강도 표현 함수
        function getIntensityDescription(trendValue) {
            var abs = Math.abs(trendValue);
            if (abs >= 20) return trendValue > 0 ? '뚜렷한 급상승' : '뚜렷한 급락';
            else if (abs >= 15) return trendValue > 0 ? '급상승' : '급락';
            else if (abs >= 10) return trendValue > 0 ? '상승' : '하락';
            else return trendValue > 0 ? '완만한 상승' : '완만한 하락';
        }
        
        function displayAIAnalysis(analysis) {
            var aiContentDiv = document.getElementById('aiContent');
            var summary = analysis.summary;
            
            var html = `
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>📊 현재 성적 현황 (고3)</h4>
                        <p><strong>응시 현황:</strong> ${summary.testCount}/${summary.totalTests}회 모의고사</p>
                        <p><strong>최고 성적:</strong> ${summary.bestGrade}등급 ${summary.bestScore}점 (${summary.bestTest}${summary.bestTestSource ? ' ' + summary.bestTestSource : ''})</p>
                        ${summary.bestTestSubjectType ? '<p><strong>선택과목:</strong> <span class="subject-type ' + summary.bestTestSubjectType.replace(/\s/g, '_') + '">' + summary.bestTestSubjectType + '</span></p>' : ''}
                        <p><strong>평균 등급:</strong> ${summary.avgGrade}등급</p>
                        <p><strong>평균 점수:</strong> ${summary.avgScore}점</p>
                        <p><strong>현재 등급:</strong> <span class="grade-${summary.latestGrade}">${summary.latestGrade}등급</span></p>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>🎯 강점 과목 분석</h4>
                        ${analysis.strengths.length > 0 ? 
                            analysis.strengths.map((s, i) => `
                                <div style="margin: 8px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>${i + 1}. ${s.subject}</span>
                                        <span style="font-weight: bold; color: #10b981;">${s.average}%</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill grade-excellent" style="width: ${s.average}%"></div>
                                    </div>
                                </div>
                            `).join('') : 
                            '<p style="color: rgba(255,255,255,0.8);">강점 과목을 분석하려면 더 많은 데이터가 필요합니다.</p>'
                        }
                    </div>
                </div>
                
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>⚠️ 개선 필요 과목</h4>
                        ${analysis.weaknesses.length > 0 ? 
                            analysis.weaknesses.map((w, i) => `
                                <div style="margin: 8px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>${i + 1}. ${w.subject}</span>
                                        <span style="font-weight: bold; color: #f87171; font-size: 0.9em;">${w.average}%</span>
                                    </div>
                                    <div style="font-size: 0.8em; color: rgba(255,255,255,0.8); margin-top: 4px;">
                                        ${w.description}
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill grade-poor" style="width: ${w.average}%"></div>
                                    </div>
                                </div>
                            `).join('') : 
                            '<p style="color: rgba(255,255,255,0.8);">모든 과목이 양호한 상태입니다.</p>'
                        }
                    </div>
                    
                    <div class="analysis-card">
                        <h4>📈 성적 추이 분석</h4>
                        ${analysis.trends.length > 0 ? 
                            analysis.trends.map(t => `
                                <div style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">
                                    <span class="trend-${t.type}">${t.type === 'up' ? '📈' : '📉'}</span>
                                    <span style="flex: 1;">${t.subject}</span>
                                    <div style="display: flex; flex-direction: column; align-items: end;">
                                        <span style="font-weight: bold; color: ${t.type === 'up' ? '#10b981' : '#f87171'};">
                                            ${t.intensity}
                                        </span>
                                        <span style="font-size: 0.75em; opacity: 0.8;">
                                            (${t.shortTermTrend > 0 ? '+' : ''}${t.shortTermTrend}%)
                                        </span>
                                    </div>
                                </div>
                            `).join('') : 
                            '<p style="color: rgba(255,255,255,0.8);">추이 분석을 위해 더 많은 시험 데이터가 필요합니다.</p>'
                        }
                    </div>
                </div>
            `;
            
            // 구체적 등급 상승 전략 섹션 추가
            if (analysis.gradeStrategy) {
                var strategy = analysis.gradeStrategy;
                var possibilityClass = 'possibility-' + strategy.possibility;
                var possibilityText = strategy.possibility === 'high' ? '매우 높음' : 
                                    strategy.possibility === 'medium' ? '보통' : '낮음';
                
                html += `
                    <div class="grade-strategy">
                        <h4>🎯 구체적 등급 상승 전략</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin-bottom: 10px; color: rgba(255,255,255,0.9);">📊 최근 4회 시험 현황</h5>
                            <div class="recent-tests-grid">
                                ${strategy.recentTests.map(test => `
                                    <div class="recent-test-item">
                                        <div class="recent-test-name">${test.name}</div>
                                        <div class="recent-test-grade grade-${test.grade}">${test.grade}등급</div>
                                        <div class="recent-test-score">${test.score}점</div>
                                    ${test.subjectType ? '<div style="font-size: 0.7em; opacity: 0.8;">' + test.subjectType + '</div>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                                평균: ${strategy.recentAvgGrade}등급 ${strategy.recentAvgScore}점
                            </div>
                        </div>
                        
                        <div class="target-analysis">
                            <div class="target-header">
                                <div>
                                    <div class="target-grade">${strategy.targetGrade}등급 달성 전략</div>
                                    <div style="font-size: 1.0em; opacity: 0.9; margin-top: 5px;">
                                        목표 점수: <strong>${strategy.targetScore}점 이상</strong> 
                                        <span style="font-size: 1.2em; font-weight: bold; color: #10b981; padding: 2px 8px; border-radius: 12px; margin-left: 8px;">
                                            현재 평균 대비 ${strategy.neededPoints > 0 ? '+' : ''}${strategy.neededPoints}점
                                        </span>
                                    </div>
                                </div>
                                <div class="target-possibility ${possibilityClass}">
                                    ${strategy.possibility === 'high' ? '💚' : strategy.possibility === 'medium' ? '💛' : '🔶'} 달성 가능성: ${possibilityText}
                                </div>
                            </div>
                        </div>
                        
                        ${strategy.subjectStrategies.length > 0 ? `
                            <div>
                                <h5 style="margin: 15px 0 10px 0; color: rgba(255,255,255,0.9);">📈 과목별 점수 확보 전략</h5>
                                <div class="subject-strategy-list">
                                    ${strategy.subjectStrategies.map((subj, i) => `
                                        <div class="subject-strategy-item">
                                            <div class="subject-strategy-left">
                                                <div class="subject-name">${i + 1}. ${subj.subject}</div>
                                                <div class="subject-detail">
                                                    성취도 ${subj.currentAvg}% 
                                                    <span style="color: ${subj.strategyColor}; font-weight: bold; padding: 2px 6px; border-radius: 8px; margin-left: 5px;">
                                                        ${subj.strategy}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="subject-strategy-right">
                                                <div class="points-gain">+${subj.possibleGain}점 확보 가능</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="total-strategy">
                                    <div class="total-points">
                                        <span>💡 총 확보 가능 점수: +${strategy.totalPossibleGain}점</span>
                                        <span style="color: ${strategy.totalPossibleGain >= strategy.neededPoints ? '#10b981' : '#f59e0b'};">
                                            ${strategy.totalPossibleGain >= strategy.neededPoints ? 
                                                '목표 달성을 위한 ' + strategy.neededPoints + '점 확보 충분히 가능!' : 
                                                '목표 달성을 위해 추가 노력 필요'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            if (analysis.recommendations.length > 0) {
                html += `
                    <div class="ai-recommendations">
                        <h4>💡 정동민국어논술학원 맞춤 학습 전략</h4>
                        ${analysis.recommendations.map(r => `
                            <div class="recommendation-item">
                                <div class="recommendation-priority">우선순위: ${r.priority}</div>
                                <div style="font-weight: bold;">${r.action}</div>
                                <div style="font-size: 0.9em; opacity: 0.9;">${r.reason}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            aiContentDiv.innerHTML = html;
        }

        // HEX 색상을 RGB로 변환하는 헬퍼 함수
        function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (result) {
                var r = parseInt(result[1], 16);
                var g = parseInt(result[2], 16);
                var b = parseInt(result[3], 16);
                return r + ',' + g + ',' + b;
            }
            return '0,0,0';
        }

        // 관리자 인증 확인
        function checkAdminPassword() {
            var password = document.getElementById('adminPassword').value.trim();
            
            if (password === '1212') {
                isAdminAuthenticated = true;
                localStorage.setItem('grade3-adminAuth', 'true');
                
                document.getElementById('adminAuthSection').style.display = 'none';
                document.getElementById('githubSetup').style.display = 'block';
                
                showStatus('✅ 관리자 인증이 완료되었습니다!', 'success');
                
                // 기존 설정이 있다면 로드
                loadExistingConfig();
            } else {
                showStatus('❌ 비밀번호가 올바르지 않습니다.', 'error');
                document.getElementById('adminPassword').value = '';
            }
        }
        
        // 관리자 접근 초기화
        function resetAdminAccess() {
            isAdminAuthenticated = false;
            localStorage.removeItem('grade3-adminAuth');        // ✅ 수정
            localStorage.removeItem('grade3-githubConfig');     // ✅ 수정
            localStorage.removeItem('grade3-dataUrl');          // ✅ 수정
            
            document.getElementById('adminAuthSection').style.display = 'block';
            document.getElementById('githubSetup').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            
            document.getElementById('adminPassword').value = '';
            showStatus('🔄 관리자 접근이 초기화되었습니다.', 'warning');
        }
        
        // 기존 설정 로드
        function loadExistingConfig() {
            var savedConfig = localStorage.getItem('grade3-githubConfig');
            var savedDataUrl = localStorage.getItem('grade3-dataUrl');
            
            if (savedConfig && savedDataUrl) {
                try {
                    githubConfig = JSON.parse(savedConfig);
                    dataUrl = savedDataUrl;
                    
                    // 입력 필드에 기존 값 채우기
                    document.getElementById('githubUsername').value = githubConfig.username || '';
                    document.getElementById('githubRepo').value = githubConfig.repo || '';
                    if (githubConfig.token) {
                        document.getElementById('githubToken').value = githubConfig.token;
                    }
                    
                    // UI 전환
                    document.getElementById('githubSetup').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                    
                    // 데이터 로드 시도
                    loadDataFromGitHub();
                } catch (error) {
                    console.error('설정 로드 실패:', error);
                }
            }
        }

        function switchTab(tabName) {
            var tabs = document.querySelectorAll('.tab');
            var contents = document.querySelectorAll('.tab-content');
            
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            if (tabName === 'student') {
                document.querySelector('.tab').classList.add('active');
                document.getElementById('studentTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                
                // 관리자 탭 접근 시 인증 상태 확인
                checkAdminAuthStatus();
            }
        }
        
        // 관리자 인증 상태 확인
        function checkAdminAuthStatus() {
            var savedAuth = localStorage.getItem('adminAuth');
            
            if (savedAuth === 'true') {
                isAdminAuthenticated = true;
                document.getElementById('adminAuthSection').style.display = 'none';
                document.getElementById('githubSetup').style.display = 'block';
                loadExistingConfig();
            } else {
                isAdminAuthenticated = false;
                document.getElementById('adminAuthSection').style.display = 'block';
                document.getElementById('githubSetup').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
            }
        }

        // GitHub 설정 저장
        function saveGitHubConfig() {
            if (!isAdminAuthenticated) {
                showStatus('❌ 관리자 인증이 필요합니다.', 'error');
                return;
            }
            
            var username = document.getElementById('githubUsername').value.trim();
            var repo = document.getElementById('githubRepo').value.trim();
            var token = document.getElementById('githubToken').value.trim();
            
            if (!username || !repo) {
                showStatus('GitHub 사용자명과 저장소 이름을 입력해주세요.', 'error');
                return;
            }
            
            githubConfig = {
                username: username,
                repo: repo,
                token: token
            };
            
            dataUrl = 'https://raw.githubusercontent.com/' + username + '/' + repo + '/main/grade3-data.json';
            
            localStorage.setItem('grade3-githubConfig', JSON.stringify(githubConfig));
            localStorage.setItem('grade3-dataUrl', dataUrl);
            
            showStatus('GitHub 설정이 저장되었습니다!', 'success');
            
            document.getElementById('githubSetup').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            
            loadDataFromGitHub();
        }
        
        // GitHub 연결 테스트
        function testGitHubConnection() {
            if (!isAdminAuthenticated) {
                showStatus('❌ 관리자 인증이 필요합니다.', 'error');
                return;
            }
            
            var username = document.getElementById('githubUsername').value.trim();
            var repo = document.getElementById('githubRepo').value.trim();
            
            if (!username || !repo) {
                showStatus('사용자명과 저장소 이름을 먼저 입력해주세요.', 'error');
                return;
            }
            
            var testUrl = 'https://api.github.com/repos/' + username + '/' + repo;
            
            showStatus('연결 테스트 중...', 'warning');
            
            fetch(testUrl)
                .then(function(response) {
                    if (response.ok) {
                        showStatus('✅ 저장소 연결 성공! 설정을 저장해주세요.', 'success');
                    } else if (response.status === 404) {
                        showStatus('❌ 저장소를 찾을 수 없습니다. 사용자명과 저장소 이름을 확인해주세요.', 'error');
                    } else {
                        showStatus('❌ 연결 실패. 저장소가 Public인지 확인해주세요.', 'error');
                    }
                })
                .catch(function(error) {
                    showStatus('❌ 네트워크 오류가 발생했습니다.', 'error');
                });
        }
        
        // GitHub에서 데이터 로드
        function loadDataFromGitHub() {
            if (!dataUrl) {
                console.log('데이터 URL이 설정되지 않음');
                return false;
            }
            
            updateDataStatus('온라인 데이터를 불러오는 중...');
            console.log('데이터 로드 시도:', dataUrl);
            
            var requestUrl = dataUrl + '?t=' + Date.now() + '&cache=' + Math.random();
            
            fetch(requestUrl)
                .then(function(response) {
                    console.log('응답 상태:', response.status);
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('데이터 파일을 찾을 수 없습니다. 관리자가 아직 데이터를 업로드하지 않았습니다.');
                        } else {
                            throw new Error('서버 오류 (' + response.status + ')');
                        }
                    }
                    return response.text();
                })
                .then(function(text) {
                    console.log('받은 데이터 크기:', text.length);
                    
                    var data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        console.error('JSON 파싱 오류:', parseError);
                        throw new Error('데이터 형식이 올바르지 않습니다.');
                    }
                    
                    console.log('파싱된 데이터:', data);
                    
                    if (!data || typeof data !== 'object') {
                        throw new Error('데이터 구조가 올바르지 않습니다.');
                    }
                    
                    studentByNumber = data.students || {};
                    maxScores = Object.assign({}, maxScores, data.maxScores || {});
                    gradeCutData = data.gradeCuts || {}; // 고3 전용: 등급컷 데이터
                    window.discoveredTestSheets = data.testSheets || [];
                    window.attendanceToNameMap = data.attendanceMap || {};
                    
                    var studentCount = Object.keys(studentByNumber).length;
                    console.log('로드된 학생 수:', studentCount);
                    
                    isDataLoaded = studentCount > 0;
                    
                    if (isDataLoaded) {
                        updateDataStatus('✅ 성적 데이터가 준비되었습니다!', true, data.lastUpdated);
                        console.log('데이터 로드 성공!');
                    } else {
                        updateDataStatus('업로드된 데이터가 비어있습니다. 관리자에게 문의하세요.');
                        console.log('데이터는 있지만 학생 정보가 없음');
                    }
                    
                    updateStudentTab();
                    return true;
                })
                .catch(function(error) {
                    console.error('데이터 로드 실패:', error);
                    updateDataStatus('데이터 로드 실패: ' + error.message);
                    isDataLoaded = false;
                    updateStudentTab();
                    return false;
                });
        }
        
        // GitHub에 데이터 업로드
        function uploadToGitHub(jsonData) {
            if (!githubConfig.username || !githubConfig.repo) {
                throw new Error('GitHub 설정이 필요합니다.');
            }
            
            var apiUrl = 'https://api.github.com/repos/' + githubConfig.username + '/' + githubConfig.repo + '/contents/grade3-data.json';
            
            return fetch(apiUrl)
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    }
                    return null;
                })
                .then(function(existingFile) {
                    var requestBody = {
                        message: '고3 성적 데이터 업데이트 - ' + new Date().toLocaleString('ko-KR'),
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(jsonData, null, 2))))
                    };
                    
                    if (existingFile && existingFile.sha) {
                        requestBody.sha = existingFile.sha;
                    }
                    
                    var headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (githubConfig.token) {
                        headers['Authorization'] = 'token ' + githubConfig.token;
                    }
                    
                    return fetch(apiUrl, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });
                })
                .then(function(response) {
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('GitHub 토큰이 유효하지 않습니다.');
                        } else if (response.status === 403) {
                            throw new Error('저장소에 쓰기 권한이 없습니다. 토큰 권한을 확인해주세요.');
                        } else {
                            throw new Error('업로드 실패 (' + response.status + ')');
                        }
                    }
                    return response.json();
                });
        }

        // 드래그앤드롭 이벤트 설정
        var uploadArea = document.getElementById('uploadArea');
        var fileInput = document.getElementById('fileInput');
        var processBtn = document.getElementById('processBtn');
        
        if (uploadArea) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    processBtn.disabled = false;
                }
            });
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                processBtn.disabled = !fileInput.files.length;
            });
        }

        function processFileAndUpload() {
            if (!isAdminAuthenticated) {
                showStatus('❌ 관리자 인증이 필요합니다.', 'error');
                return;
            }
            
            var file = fileInput.files[0];
            if (!file) {
                showStatus('파일을 선택해주세요.', 'error');
                return;
            }
            
            if (!githubConfig.username || !githubConfig.repo) {
                showStatus('GitHub 설정을 먼저 완료해주세요.', 'error');
                return;
            }
            
            showProgress(true);
            updateProgress(10, '파일 읽는 중...');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateProgress(30, '데이터 파싱 중...');
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    
                    updateProgress(50, '고3 학생 데이터 처리 중...');
                    parseExcelDataGrade3(workbook);
                    
                    updateProgress(70, 'GitHub에 업로드 중...');
                    
                    var uploadData = {
                    students: studentByNumber,
                    maxScores: maxScores,
                    gradeCuts: gradeCutData,
                    testSheets: window.discoveredTestSheets,
                    attendanceMap: window.attendanceToNameMap,
                    lastUpdated: new Date().toISOString()
                };
                    
                    uploadToGitHub(uploadData)
                        .then(function(result) {
                            updateProgress(100, '완료!');
                            setTimeout(function() {
                                showProgress(false);
                                showStatus('✅ 고3 데이터가 성공적으로 GitHub에 업로드되었습니다!', 'success');
                                
                                setTimeout(function() {
                                    loadDataFromGitHub();
                                }, 1000);
                                
                                updateDataSummary();
                                updateStudentTab();
                            }, 500);
                        })
                        .catch(function(error) {
                            showProgress(false);
                            showStatus('GitHub 업로드 실패: ' + error.message, 'error');
                            console.error('업로드 오류:', error);
                        });
                    
                } catch (error) {
                    showProgress(false);
                    showStatus('파일 처리 중 오류가 발생했습니다: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 등급컷 처리 함수 (3번째 시트에서 읽기)
        function processGradeCuts(workbook) {
            gradeCutData = {}; // 초기화
            
            // 3번째 시트에서 등급컷 정보 읽기
            var gradeCutSheetName = workbook.SheetNames[2]; // 3번째 시트 (인덱스 2)
            if (!workbook.Sheets[gradeCutSheetName]) {
                console.log('등급컷 시트를 찾을 수 없습니다:', gradeCutSheetName);
                return;
            }
            
            var gradeCutSheet = workbook.Sheets[gradeCutSheetName];
            var gradeCutSheetData = XLSX.utils.sheet_to_json(gradeCutSheet, {header: 1});
            
            console.log('등급컷 시트 처리 중:', gradeCutSheetName);
            console.log('등급컷 원본 데이터:', gradeCutSheetData);
            
            // A열: 시험명, B열: 시험출처, C열: 선택과목, D열부터: 1등급, 2등급, 3등급...
            for (var i = 1; i < gradeCutSheetData.length; i++) {
                var row = gradeCutSheetData[i];
                if (!row || !row[0] || !row[2]) continue; // A열(시험명)과 C열(선택과목)이 없으면 스킵
                
                var testName = row[0].toString().trim();
                var source = row[1] ? row[1].toString().trim() : '';
                var subjectType = row[2].toString().trim();
                
                // 시험명 정규화 (공백 제거)
                var normalizedTestName = testName.replace(/\s/g, '');
                
                console.log('등급컷 처리:', normalizedTestName, '/', subjectType);
                
                if (!gradeCutData[normalizedTestName]) {
                gradeCutData[normalizedTestName] = {};
            }
                
                // D열부터 등급컷 정보 (D=1등급, E=2등급, F=3등급...)
                var cuts = {};
                for (var grade = 1; grade <= 9; grade++) {
                    var cutScore = row[3 + grade - 1]; // D열은 인덱스 3
                    if (cutScore !== null && cutScore !== undefined && cutScore !== '') {
                        cuts[grade] = parseInt(cutScore);
                        console.log('  ', grade + '등급:', cuts[grade] + '점');
                    }
                }
                
                gradeCutData[normalizedTestName][subjectType] = {
                source: source,
                cuts: cuts
            };
            
            console.log('등급컷 저장 완료:', normalizedTestName, subjectType, cuts);
            }
            
            console.log('=== 최종 등급컷 데이터 ===');
            console.log(gradeCutData);
        }
        
            
               
        // parseExcelDataGrade3 함수 수정 (기존 등급컷 처리 부분 교체)
        function parseExcelDataGrade3(workbook) {
            var attendanceToNameMap = {};
            var studentsByName = {};
            var testSources = {};
            
            console.log('=== 고3 엑셀 데이터 파싱 시작 ===');
            console.log('시트 목록:', workbook.SheetNames);
            
           // 1. 등급컷 처리 (3번째 시트)
            processGradeCuts(workbook);
            
            // 2. 첫번째 시트에서 시험 출처 정보 추출 (고2 방식)
            extractTestSourcesFromFirstSheet(workbook);

            // 첫 번째 시트에서 출처 정보 추출하는 함수 (고2 방식)
            function extractTestSourcesFromFirstSheet(workbook) {
                var testSources = {};
                
                var firstSheetName = workbook.SheetNames[0];
                if (!workbook.Sheets[firstSheetName]) {
                    console.log('첫 번째 시트를 찾을 수 없습니다:', firstSheetName);
                    return testSources;
                }
                
                var firstSheet = workbook.Sheets[firstSheetName];
                var firstSheetData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                console.log('첫 번째 시트에서 출처 정보 추출:', firstSheetName);
                
                var sourceStartRow = -1;
                var testNameColumn = 0;  // A열
                var sourceColumn = 12;   // M열 (인덱스 12)
                
                // "시험출처" 헤더가 있는 행 찾기
                for (var i = 0; i < firstSheetData.length; i++) {
                    var row = firstSheetData[i];
                    if (row) {
                        for (var j = 0; j < row.length; j++) {
                            if (row[j] && row[j].toString().includes('시험출처')) {
                                sourceStartRow = i + 1; // 데이터는 다음 행부터
                                console.log('시험출처 헤더 발견, 데이터 시작 행:', sourceStartRow + 1);
                                break;
                            }
                        }
                        if (sourceStartRow !== -1) break;
                    }
                }
                
                if (sourceStartRow === -1) {
                    console.log('시험출처 헤더를 찾지 못함');
                    return testSources;
                }
                
                // 시험 출처 데이터 추출
                for (var i = sourceStartRow; i < firstSheetData.length; i++) {
                    var row = firstSheetData[i];
                    if (row && row[testNameColumn] && row[sourceColumn]) {
                        var testName = row[testNameColumn].toString().trim();
                        var source = row[sourceColumn].toString().trim();
                        
                        if (testName.includes('모클') || testName.includes('이감') || testName.includes('진단')) {
                            testSources[testName] = source;
                            console.log('출처 매핑:', testName, '->', source);
                        }
                    }
                }
                
                window.testSources = testSources;
                console.log('최종 수집된 시험 출처:', testSources);
                
                return testSources;
            }
            
            // 3. 출결번호-이름 매핑 처리
            var mappingSheetName = workbook.SheetNames[1];
            if (workbook.Sheets[mappingSheetName]) {
                var mappingSheet = workbook.Sheets[mappingSheetName];
                var mappingData = XLSX.utils.sheet_to_json(mappingSheet, {header: 1});
                
                console.log('출결번호-이름 매핑 시트:', mappingSheetName);
                
                for (var i = 1; i < mappingData.length; i++) {
                    var row = mappingData[i];
                    if (row && row[0] && row[1]) {
                        var name = row[0];
                        var attendanceNumber = row[1];
                        attendanceToNameMap[attendanceNumber] = name;
                        
                        if (!studentsByName[name]) {
                            studentsByName[name] = {
                                name: name,
                                attendanceNumber: attendanceNumber,
                                grades: {}
                            };
                        }
                    }
                }
                
                console.log('총 매핑된 학생 수:', Object.keys(attendanceToNameMap).length);
            }
            
            // 4. 모클 시트 찾기
            var allSheetNames = workbook.SheetNames;
            var testSheetNames = [];
            
            for (var i = 0; i < allSheetNames.length; i++) {
                var sheetName = allSheetNames[i];
                if ((sheetName.includes('모클') || sheetName.includes('이감') || sheetName.includes('진단평가')) && 
                    !sheetName.includes('성적표') && sheetName !== '등급컷' && sheetName !== '출결번호') {
                    testSheetNames.push(sheetName);
                }
            }
            
            testSheetNames.sort(function(a, b) {
                var numA = parseInt(a.match(/\d+/));
                var numB = parseInt(b.match(/\d+/));
                return numA - numB;
            });
            
            console.log('발견된 모클 시트들:', testSheetNames);
            
            // 5. 만점 추출
            console.log('=== 고3 만점 추출 시작 ===');
            extractMaxScoresGrade3(workbook, testSheetNames);
            console.log('추출 완료된 maxScores:', maxScores);
            
            // 6. 학생 데이터 처리
            console.log('=== 학생 데이터 처리 시작 ===');
            for (var s = 0; s < testSheetNames.length; s++) {
                var sheetName = testSheetNames[s];
                if (!workbook.Sheets[sheetName]) continue;
                
                console.log('처리 중인 시트:', sheetName);
                
                var worksheet = workbook.Sheets[sheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                if (jsonData.length <= 1) continue;
                
                var headers = jsonData[0];
                var sheetMaxScores = maxScores[sheetName] || {};
                
                console.log(sheetName + ' 헤더:', headers);
                console.log(sheetName + ' 첫 번째 데이터 행:', jsonData[1]);

                for (var i = 1; i < jsonData.length; i++) {
                    var row = jsonData[i];
                    if (!row || !row[0]) continue;
                    
                    var name = row[0];
                    if (!studentsByName[name]) continue;
                    
                    var attendanceNumber = row[1];
                    var subjectTypeFromSheet = row[2]; // C열: 선택과목 (직접 읽기)
                    var gradeFromSheet = row[3]; // D열: 등급 (직접 읽기)
                    var scoreFromSheet = row[4]; // E열: 점수
                    
                    console.log('\n=== 학생 처리:', name, '(' + attendanceNumber + ') ===');
                    console.log('선택과목:', subjectTypeFromSheet);
                    console.log('등급:', gradeFromSheet);
                    console.log('점수:', scoreFromSheet);
                    
                    // 첫 번째 시트에서 추출한 출처 정보 사용
                    var source = '';
                    if (window.testSources && window.testSources[sheetName]) {
                        source = window.testSources[sheetName];
                    }
                    console.log('시험:', sheetName, '출처:', source);
                    
                    // 과목별 점수 수집 (F열부터)
                    var details = {};
                    var ratios = {};
                    
                    for (var j = 5; j < Math.min(headers.length, row.length); j++) {
                        var subject = headers[j];
                        var subjectScore = row[j];
                        
                        if (subject && subjectScore !== null && subjectScore !== undefined && subjectScore !== '') {
                            details[subject] = subjectScore;
                            
                            var maxScore = sheetMaxScores[subject];
                            if (maxScore) {
                                ratios[subject] = Math.round((subjectScore / maxScore) * 100);
                            } else {
                                // 화법과 작문 만점 추정
                                if (subject.includes('화법') || subject.includes('작문')) {
                                    var estimatedMax = 22;
                                    if (sheetName === '모클4회' || sheetName === '모클5회') {
                                        estimatedMax = 13;
                                    }
                                    ratios[subject] = Math.round((subjectScore / estimatedMax) * 100);
                                }
                            }
                        }
                    }
                    
                    // 1. 선택과목은 C열에서 직접 읽기
                    var finalSubjectType = subjectTypeFromSheet || '화법과 작문';
                    
                    // 2. 등급은 D열에서 직접 읽기 (null이면 null 그대로)
                    var finalGrade = null;
                    if (gradeFromSheet && gradeFromSheet !== '' && gradeFromSheet !== null) {
                        finalGrade = parseInt(gradeFromSheet);
                    }
                    
                    // 3. 필요점수는 3번째 시트 등급컷으로 계산
                    var gradeCut = '';
                    var needScore = null;
                    
                    if (finalGrade && finalSubjectType && scoreFromSheet && gradeCutData[sheetName]) {
                        var cuts = gradeCutData[sheetName][finalSubjectType];
                        
                        if (cuts && cuts.cuts) {
                            gradeCut = cuts.cuts[finalGrade] || '';
                            
                            // 한 등급 올리기 위해 필요한 점수 계산
                            if (finalGrade > 1 && cuts.cuts[finalGrade - 1]) {
                                needScore = cuts.cuts[finalGrade - 1] - parseInt(scoreFromSheet);
                                
                                // 이미 달성한 경우
                                if (needScore <= 0) {
                                    needScore = 0;
                                }
                            }
                        }
                    }
                    
                    console.log('최종 결과:', sheetName, name);
                    console.log('  점수:', scoreFromSheet);
                    console.log('  선택과목:', finalSubjectType);
                    console.log('  등급:', finalGrade);
                    console.log('  등급컷:', gradeCut);
                    console.log('  다음 등급까지:', needScore, '점');
                    
                    studentsByName[name].grades[sheetName] = {
                        grade: finalGrade,
                        score: scoreFromSheet,
                        subjectType: finalSubjectType,
                        details: details,
                        ratios: ratios,
                        needScore: needScore,
                        gradeCut: gradeCut,
                        source: source
                    };
                }
                
            }
            
            // 7. 최종 데이터 구성
            studentByNumber = {};
            for (var attendanceNumber in attendanceToNameMap) {
                var name = attendanceToNameMap[attendanceNumber];
                if (studentsByName[name]) {
                    studentByNumber[attendanceNumber] = studentsByName[name];
                }
            }
            
            window.discoveredTestSheets = testSheetNames;
            window.attendanceToNameMap = attendanceToNameMap;
            isDataLoaded = true;
            
            console.log('최종 처리된 학생 수:', Object.keys(studentByNumber).length);
            console.log('최종 등급컷 데이터:', gradeCutData);
            
            // 디버깅: 첫 번째 학생의 데이터 확인
            var firstStudentKey = Object.keys(studentByNumber)[0];
            if (firstStudentKey) {
                console.log('첫 번째 학생 데이터 확인:', studentByNumber[firstStudentKey]);
            }
        }

        function extractMaxScoresGrade3(workbook, testSheetNames) {
            console.log('고3 각 시트에서 직접 만점 추출 시작...');
            
            maxScores = {};
            
            for (var i = 0; i < testSheetNames.length; i++) {
                var sheetName = testSheetNames[i];
                if (!workbook.Sheets[sheetName]) continue;
                
                var worksheet = workbook.Sheets[sheetName];
                var sheetData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                if (sheetData.length <= 1) continue;
                
                var headers = sheetData[0];
                console.log(sheetName + ' 헤더:', headers);
                
                maxScores[sheetName] = {};
                
                // 고3은 5번째 열부터 과목 시작 (0부터 세면 인덱스 5)
                for (var colIndex = 5; colIndex < headers.length; colIndex++) {
                    var subject = headers[colIndex];
                    if (!subject) continue;
                    
                    var maxScore = 0;
                    var validScores = [];
                    
                    for (var rowIndex = 1; rowIndex < sheetData.length; rowIndex++) {
                        var row = sheetData[rowIndex];
                        if (row && row[colIndex] !== null && row[colIndex] !== undefined && row[colIndex] !== '') {
                            var score = parseFloat(row[colIndex]);
                            if (!isNaN(score) && score > 0) {
                                validScores.push(score);
                                maxScore = Math.max(maxScore, score);
                            }
                        }
                    }
                    
                    if (maxScore > 0) {
                        maxScores[sheetName][subject] = maxScore;
                        console.log('고3 직접 추출된 만점:', sheetName, '"' + subject + '"', '=', maxScore + '점', '(유효 점수:', validScores.length + '개)');
                    } else {
                        console.log('⚠️ 유효한 점수 없음:', sheetName, subject);
                    }
                }
                
                console.log(sheetName + ' 추출 완료:', maxScores[sheetName]);
            }
            
            console.log('고3 모든 시트 만점 추출 완료:', maxScores);
        }
        
        function showProgress(show) {
            document.getElementById('progressContainer').style.display = show ? 'block' : 'none';
        }
        
        function updateProgress(percent, message) {
            var progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = message || (percent + '%');
        }
        
        function showStatus(message, type) {
            var statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(function() {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function updateDataSummary() {
            var summaryDiv = document.getElementById('dataSummary');
            var gridDiv = document.getElementById('summaryGrid');
            
            var totalStudents = Object.keys(studentByNumber).length;
            var mappingCount = window.attendanceToNameMap ? Object.keys(window.attendanceToNameMap).length : 0;
            var discoveredSheets = window.discoveredTestSheets ? window.discoveredTestSheets.length : 0;
            var gradeCutCount = Object.keys(gradeCutData).length;
            
            var html = '<div class="summary-item"><div class="summary-value">' + mappingCount + '</div><div class="summary-label">매핑 테이블 학생수</div></div>';
            html += '<div class="summary-item"><div class="summary-value">' + totalStudents + '</div><div class="summary-label">성적 데이터 학생수</div></div>';
            html += '<div class="summary-item"><div class="summary-value">' + discoveredSheets + '</div><div class="summary-label">발견된 시트 수</div></div>';
            html += '<div class="summary-item"><div class="summary-value">' + gradeCutCount + '</div><div class="summary-label">등급컷 시험 수</div></div>';
            
            if (githubConfig.username && githubConfig.repo) {
                html += '<div class="summary-item"><div class="summary-value" style="font-size: 0.9em;">' + githubConfig.username + '/' + githubConfig.repo + '</div><div class="summary-label">GitHub 저장소</div></div>';
            }
            
            gridDiv.innerHTML = html;
            summaryDiv.style.display = 'block';
        }
        
        function updateDataStatus(message, isSuccess, lastUpdated) {
            var statusMessage = document.getElementById('dataStatusMessage');
            var noDataDiv = document.getElementById('noData');
            
            if (isSuccess && lastUpdated) {
                var updateDate = new Date(lastUpdated);
                var formattedDate = updateDate.toLocaleDateString('ko-KR') + ' ' + updateDate.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                statusMessage.innerHTML = message + '<br><small style="color: #666;">마지막 업데이트: ' + formattedDate + '</small>';
                noDataDiv.style.background = '#d4edda';
                noDataDiv.style.color = '#155724';
                noDataDiv.style.border = '1px solid #c3e6cb';
            } else {
                statusMessage.innerHTML = message;
                noDataDiv.style.background = '#f8f9fa';
                noDataDiv.style.color = '#666';
                noDataDiv.style.border = 'none';
            }
        }
        
        function updateStudentTab() {
            var noDataDiv = document.getElementById('noData');
            var searchBtn = document.getElementById('searchBtn');
            
            if (isDataLoaded && Object.keys(studentByNumber).length > 0) {
                searchBtn.disabled = false;
                
                if (githubConfig.username && githubConfig.repo) {
                    var shareableUrl = window.location.origin + window.location.pathname + 
                                     '?username=' + githubConfig.username + '&repo=' + githubConfig.repo;
                    document.getElementById('shareableUrl').textContent = shareableUrl;
                    document.getElementById('urlInfo').style.display = 'block';
                }
            } else {
                searchBtn.disabled = true;
                document.getElementById('urlInfo').style.display = 'none';
            }
        }

        function searchStudent() {
            if (!isDataLoaded) {
                alert('데이터가 로드되지 않았습니다.');
                return;
            }
            
            var query = document.getElementById('searchInput').value.trim();
            var resultsDiv = document.getElementById('results');
            var noResultsDiv = document.getElementById('noResults');
            var noDataDiv = document.getElementById('noData');
            
            resultsDiv.style.display = 'none';
            noResultsDiv.style.display = 'none';
            noDataDiv.style.display = 'none';
            
            if (!query) {
                alert('출결번호를 입력해주세요.');
                return;
            }
            
            var student = studentByNumber[query];
            
            if (!student) {
                noResultsDiv.style.display = 'block';
                return;
            }
            
            displayStudentInfo(student);
            generateAIAnalysis(student); // AI 분석 실행
            displaySummaryTable(student);
            displayGrades(student.grades);
            resultsDiv.style.display = 'block';

           // 뱃지 툴팁 이벤트를 더 긴 지연 후 실행
            setTimeout(addBadgeTooltipEvents, 500);

            // 그래프 생성 (약간의 지연 후)
            setTimeout(function() {
                createChart(student);
            }, 100);
            
        }

        function displayStudentInfo(student) {
            var studentInfoDiv = document.getElementById('studentInfo');
            var gradeKeys = Object.keys(student.grades);
            var totalTests = window.discoveredTestSheets ? window.discoveredTestSheets.length : 12;
            var attendedTests = gradeKeys.length;
            
            // 선택과목 정보 추출
            var subjectTypes = [];
            console.log('=== 선택과목 정보 추출 시작 ===');
            gradeKeys.forEach(function(testName) {
                var gradeData = student.grades[testName];
                console.log('시험:', testName, '선택과목:', gradeData.subjectType);
                if (gradeData.subjectType && subjectTypes.indexOf(gradeData.subjectType) === -1) {
                    subjectTypes.push(gradeData.subjectType);
                }
            });
            console.log('최종 subjectTypes 배열:', subjectTypes);
            
            var subjectTypeDisplay = '';
            if (subjectTypes.length > 0) {
                subjectTypeDisplay = '<div style="display: flex; justify-content: space-between;"><span style="font-weight: 600; color: #555;">선택과목:</span><span style="color: #333; font-weight: bold;">' + subjectTypes.join(', ') + '</span></div>';
            }
            
            studentInfoDiv.innerHTML = 
                '<div class="student-info">' +
                '<h2>👨‍🎓 ' + student.name + ' (고3)</h2>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">' +
                '<div style="display: flex; justify-content: space-between;"><span style="font-weight: 600; color: #555;">출결번호:</span><span style="color: #333; font-weight: bold;">' + student.attendanceNumber + '</span></div>' +
                '<div style="display: flex; justify-content: space-between;"><span style="font-weight: 600; color: #555;">응시 현황:</span><span style="color: #333; font-weight: bold;">' + attendedTests + '/' + totalTests + '회</span></div>' +
                subjectTypeDisplay +
                '</div></div>' +
               displayStudyFortune(student.name) +
                displayDashboard(student);
            
                   // 🆕 학습 계획서 섹션 표시
document.getElementById('studyPlanSection').style.display = 'block';
        }

        function displaySummaryTable(student) {
            var summaryTableDiv = document.getElementById('summaryTable');
            
            var allTests = window.discoveredTestSheets || ['모클1회', '모클2회', '모클3회'];
            var totalTests = allTests.length;
            
            var tableHtml = '<div class="summary-table">';
            tableHtml += '<h3>📊 전체 성적 현황 (고3 - ' + totalTests + '개 시험)</h3>';
            tableHtml += '<table class="grade-table">';
            tableHtml += '<thead><tr>';
            tableHtml += '<th class="test-name">시험</th>';
            tableHtml += '<th>선택과목</th>';
            tableHtml += '<th>등급</th>';
            tableHtml += '<th>점수</th>';
            tableHtml += '<th>등급컷</th>';
            tableHtml += '<th>필요점수</th>';
            tableHtml += '<th>출처</th>';
            tableHtml += '</tr></thead><tbody>';
            
            for (var i = 0; i < allTests.length; i++) {
                var testName = allTests[i];
                var gradeData = student.grades[testName];
                
                tableHtml += '<tr>';
                tableHtml += '<td class="test-name">' + testName + '</td>';
                
                if (gradeData) {
                    var subjectTypeClass = (gradeData.subjectType || '').replace(/\s/g, '_');
                    tableHtml += '<td class="source-cell"><span class="subject-type ' + subjectTypeClass + '">' + (gradeData.subjectType || '-') + '</span></td>';
                    tableHtml += '<td class="grade-cell grade-' + gradeData.grade + '">' + gradeData.grade + '</td>';
                    tableHtml += '<td class="score-cell">' + gradeData.score + '</td>';
                    tableHtml += '<td class="score-cell">' + (gradeData.gradeCut || '-') + '</td>';
                    
                    var needScoreDisplay = '';
                    if (gradeData.needScore !== null && gradeData.needScore !== undefined) {
                        needScoreDisplay = gradeData.needScore > 0 ? '(' + gradeData.needScore + ')' : '달성';
                    }
                    tableHtml += '<td class="score-cell">' + needScoreDisplay + '</td>';
                    tableHtml += '<td class="source-cell">' + (gradeData.source || '-') + '</td>';
                } else {
                    tableHtml += '<td class="absent-cell">-</td>';
                    tableHtml += '<td class="absent-cell">미응시</td>';
                    tableHtml += '<td class="absent-cell">-</td>';
                    tableHtml += '<td class="absent-cell">-</td>';
                    tableHtml += '<td class="absent-cell">-</td>';
                    tableHtml += '<td class="absent-cell">-</td>';
                }
                
                tableHtml += '</tr>';
            }
            
            tableHtml += '</tbody></table></div>';
            
            tableHtml += '<div class="summary-table" style="margin-top: 30px;">';
            tableHtml += '<h3>📈 과목별 성취도 비율 현황</h3>';
            tableHtml += '<div style="overflow-x: auto;">';
            tableHtml += '<table class="grade-table" style="min-width: 1200px; font-size: 0.8em;">';
            tableHtml += '<thead><tr>';
            tableHtml += '<th style="min-width: 80px; font-size: 0.85em;">시험</th>';
            tableHtml += '<th style="min-width: 80px; font-size: 0.85em;">선택과목</th>';
            tableHtml += '<th style="min-width: 50px; font-size: 0.85em;">등급</th>';
            tableHtml += '<th style="min-width: 50px; font-size: 0.85em;">점수</th>';
            tableHtml += '<th style="min-width: 80px; font-size: 0.85em;">독서(인문이론)</th>';
            tableHtml += '<th style="min-width: 60px; font-size: 0.85em;">독서(사회)</th>';
            tableHtml += '<th style="min-width: 80px; font-size: 0.85em;">독서(과학)</th>';
            tableHtml += '<th style="min-width: 80px; font-size: 0.85em;">문학(현대시)</th>';
            tableHtml += '<th style="min-width: 90px; font-size: 0.85em;">문학(현대소설)</th>';
            tableHtml += '<th style="min-width: 90px; font-size: 0.85em;">문학(고전시가)</th>';
            tableHtml += '<th style="min-width: 90px; font-size: 0.85em;">문학(고전소설)</th>';
            tableHtml += '<th style="min-width: 70px; font-size: 0.85em;">언어화법</th>';
            tableHtml += '<th style="min-width: 70px; font-size: 0.85em;">매체작문</th>';
            tableHtml += '<th style="min-width: 70px; font-size: 0.85em;">시험출처</th>';
            tableHtml += '</tr></thead><tbody>';
            
            for (var i = 0; i < allTests.length; i++) {
                var testName = allTests[i];
                var gradeData = student.grades[testName];
                
                tableHtml += '<tr>';
                tableHtml += '<td class="test-name" style="font-size: 0.85em;">' + testName + '</td>';
                
                if (gradeData) {
                    var subjectTypeClass2 = (gradeData.subjectType || '').replace(/\s/g, '_');
                    tableHtml += '<td class="source-cell" style="font-size: 0.8em;"><span class="subject-type ' + subjectTypeClass2 + '">' + (gradeData.subjectType || '-') + '</span></td>';
                    tableHtml += '<td class="grade-cell grade-' + gradeData.grade + '" style="font-size: 0.85em;">' + gradeData.grade + '</td>';
                    tableHtml += '<td class="score-cell" style="font-size: 0.85em;">' + gradeData.score + '</td>';
                    
                    var subjectOrder = ['독서(인문 이론)', '독서(사회)', '독서(과학)', 
                                       '문학(현대시)', '문학(현대소설)', '문학(고전시가)', '문학(고전소설)',
                                       '언어 화법', '매체 작문'];
                    
                    for (var j = 0; j < subjectOrder.length; j++) {
                        var targetSubject = subjectOrder[j];
                        var ratio = 0;
                        
                        // 과목명 매핑 테이블
                        var subjectMapping = {
                            '독서(인문 이론)': ['독서(인문 이론)', '독서(인문이론)', '독서인문', '인문'],
                            '독서(사회)': ['독서(사회)', '독서사회', '사회'],
                            '독서(과학)': ['독서(과학)', '독서과학', '과학'],
                            '문학(현대시)': ['문학(현대시)', '문학현대시', '현대시', '현시'],
                            '문학(현대소설)': ['문학(현대소설)', '문학현대소설', '현대소설', '현소'],
                            '문학(고전시가)': ['문학(고전시가)', '문학고전시가', '고전시가', '고시'],
                            '문학(고전소설)': ['문학(고전소설)', '문학고전소설', '고전소설', '고소'],
                            '언어 화법': ['언어 화법', '언어화법', '화법'],
                            '매체 작문': ['매체 작문', '매체작문', '작문']
                        };
                        
                        // 매칭되는 과목 찾기
                        var possibleNames = subjectMapping[targetSubject] || [targetSubject];
                        
                        for (var actualSubject in gradeData.ratios) {
                            var found = false;
                            
                            // 정확한 매칭 우선
                            for (var k = 0; k < possibleNames.length; k++) {
                                if (actualSubject === possibleNames[k]) {
                                    ratio = gradeData.ratios[actualSubject] || 0;
                                    found = true;
                                    break;
                                }
                            }
                            
                            // 정확한 매칭이 없으면 부분 매칭
                            if (!found) {
                                for (var k = 0; k < possibleNames.length; k++) {
                                    if (actualSubject.includes(possibleNames[k]) || possibleNames[k].includes(actualSubject)) {
                                        ratio = gradeData.ratios[actualSubject] || 0;
                                        found = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (found) break;
                        }
                        
                        var ratioColor = ratio >= 90 ? '#e74c3c' : ratio >= 80 ? '#f39c12' : ratio >= 70 ? '#f1c40f' : 
                                        ratio >= 60 ? '#2ecc71' : ratio >= 50 ? '#3498db' : '#95a5a6';
                        var ratioText = ratio > 0 ? ratio + '%' : '-';
                        
                        tableHtml += '<td style="color: ' + ratioColor + '; font-weight: bold; text-align: center; font-size: 0.85em;">' + ratioText + '</td>';
                    }
                    
                    tableHtml += '<td class="source-cell" style="font-size: 0.85em;">' + (gradeData.source || '-') + '</td>';
                } else {
                    tableHtml += '<td class="absent-cell" style="font-size: 0.85em;">-</td>';
                    tableHtml += '<td class="absent-cell" style="font-size: 0.85em;">미응시</td>';
                    tableHtml += '<td class="absent-cell" style="font-size: 0.85em;">-</td>';
                    for (var k = 0; k < 10; k++) {
                        tableHtml += '<td class="absent-cell" style="font-size: 0.85em;">-</td>';
                    }
                    tableHtml += '<td class="absent-cell" style="font-size: 0.85em;">-</td>';
                }
                
                tableHtml += '</tr>';
            }
            
            tableHtml += '</tbody></table></div></div>';
            
            summaryTableDiv.innerHTML = tableHtml;
        }

        function displayGrades(grades) {
            var gradeCardsDiv = document.getElementById('gradeCards');
            gradeCardsDiv.innerHTML = '';
            
            var testNames = Object.keys(grades);
            
            for (var i = 0; i < testNames.length; i++) {
                var testName = testNames[i];
                var gradeData = grades[testName];
                var gradeCard = document.createElement('div');
                gradeCard.className = 'grade-card';
                
                var detailsHtml = '';
                if (gradeData.details) {
                    var detailKeys = Object.keys(gradeData.details);
                    for (var j = 0; j < detailKeys.length; j++) {
                        var subject = detailKeys[j];
                        var score = gradeData.details[subject];
                        var ratio = gradeData.ratios[subject] || 0;
                        var ratioColor = ratio >= 80 ? '#e74c3c' : ratio >= 60 ? '#f39c12' : ratio >= 40 ? '#f1c40f' : '#95a5a6';
                        
                        detailsHtml += 
                        '<div class="grade-item" style="padding: 4px 8px; font-size: 0.8em;">' +
                        '<span class="grade-label" style="font-size: 0.75em;">' + subject + '</span>' +
                        '<span class="grade-value" style="font-size: 0.8em;">' + score + '점 ' +
                        '<span style="color: ' + ratioColor + '; font-size: 0.7em;">(' + ratio + '%)</span>' +
                        '</span></div>';
                    }
                }

                                
                var cutInfo = '';
                
                // 선택과목 정보 추가
                if (gradeData.subjectType) {
                    cutInfo += '<div class="grade-summary-item"><div class="grade-summary-value" style="font-size: 0.9em; color: #667eea;">' + gradeData.subjectType + '</div><div class="grade-summary-label">선택과목</div></div>';
                }
                
              if (gradeData.gradeCut) {
                cutInfo += '<div class="grade-summary-item"><div class="grade-summary-value" style="font-size: 1.1em;">' + gradeData.gradeCut + '점</div><div class="grade-summary-label" style="font-size: 0.75em;">내 등급컷</div></div>';
            }
            
            if (gradeData.needScore !== null && gradeData.needScore !== undefined) {
                var needScoreDisplay = gradeData.needScore > 0 ? '+' + gradeData.needScore : gradeData.needScore;
                var needScoreColor = gradeData.needScore <= 0 ? '#2ecc71' : '#e74c3c';
                cutInfo += '<div class="grade-summary-item"><div class="grade-summary-value" style="color: ' + needScoreColor + '; font-size: 1.1em;">' + needScoreDisplay + '점</div><div class="grade-summary-label" style="font-size: 0.75em;">한등급↑ 필요점수</div></div>';
            }
            
            var sourceInfo = '';
            if (gradeData.source && gradeData.source.trim() !== '') {
                sourceInfo = '<div class="grade-summary-item"><div class="grade-summary-value" style="font-size: 0.8em; color: #666;">' + gradeData.source + '</div><div class="grade-summary-label" style="font-size: 0.75em;">출처</div></div>';
            }
                
                gradeCard.innerHTML = 
                '<h3 style="font-size: 1.1em; margin-bottom: 12px;">📝 ' + testName + '</h3>' +
                '<div class="grade-summary" style="grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 12px; padding: 10px;">' +
                '<div class="grade-summary-item"><div class="grade-summary-value grade-' + gradeData.grade + '" style="font-size: 1.1em;">' + gradeData.grade + '등급</div><div class="grade-summary-label" style="font-size: 0.75em;">내 등급</div></div>' +
                '<div class="grade-summary-item"><div class="grade-summary-value" style="font-size: 1.1em;">' + gradeData.score + '점</div><div class="grade-summary-label" style="font-size: 0.75em;">내 점수</div></div>' +
                cutInfo + sourceInfo + '</div>' +
                (detailsHtml ? '<div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 6px;"><h4 style="margin-bottom: 8px; color: #333; font-size: 0.85em;">📊 과목별 성취도 (점수 및 비율)</h4><div class="grade-details" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px;">' + detailsHtml + '</div></div>' : '');
              
                gradeCardsDiv.appendChild(gradeCard);
            }
        }

        // 이벤트 리스너
        document.getElementById('searchInput').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            if (e.target.value.length > 4) {
                e.target.value = e.target.value.slice(0, 4);
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudent();
            }
        });

        // 등급컷 시트에서 출처 정보 추출하는 새 함수
                function extractTestSourcesFromGradeCuts(workbook) {
                    var testSources = {};
                    
                    // 3번째 시트에서 출처 정보 추출
                    var gradeCutSheetName = workbook.SheetNames[2];
                    if (!workbook.Sheets[gradeCutSheetName]) {
                        console.log('등급컷 시트를 찾을 수 없습니다:', gradeCutSheetName);
                        return testSources;
                    }
                    
                    var gradeCutSheet = workbook.Sheets[gradeCutSheetName];
                    var gradeCutSheetData = XLSX.utils.sheet_to_json(gradeCutSheet, {header: 1});
                    
                    console.log('등급컷 시트에서 출처 정보 추출:', gradeCutSheetName);
                    
                    for (var i = 1; i < gradeCutSheetData.length; i++) {
                        var row = gradeCutSheetData[i];
                        if (!row || !row[0] || !row[1]) continue;
                        
                        var testName = row[0].toString().trim();
                        var source = row[1].toString().trim();
                        
                        var normalizedTestName = testName.replace(/\s/g, '');
                        
                        if (!testSources[normalizedTestName]) {
                            testSources[normalizedTestName] = source;
                            console.log('출처 매핑:', normalizedTestName, '->', source);
                        }
                    }
                    
                    window.testSources = testSources;
                    console.log('최종 수집된 시험 출처:', testSources);
                    
                    return testSources;
                }
        
        // 페이지 로드 시 실행
        window.onload = function() {
            console.log('페이지 로드 시작');
            
            // URL 파라미터에서 설정 확인
            var urlParams = new URLSearchParams(window.location.search);
            var urlUsername = urlParams.get('username');
            var urlRepo = urlParams.get('repo');
            
            var autoConfig = null;
            
            // URL 파라미터에서 설정을 찾았을 때
            if (urlUsername && urlRepo) {
                console.log('URL 파라미터에서 설정 발견:', urlUsername, urlRepo);
                autoConfig = {
                    username: urlUsername,
                    repo: urlRepo,
                    token: ''
                };
            } else {
                // GitHub Pages 자동 감지
                var hostname = window.location.hostname;
                var pathname = window.location.pathname;
                
                if (hostname.includes('.github.io')) {
                    var username = hostname.split('.')[0];
                    var repo = pathname.split('/')[1] || 'grade3-data';
                    
                    if (username && repo) {
                        console.log('GitHub Pages에서 자동 감지된 설정:', username, repo);
                        autoConfig = {
                            username: username,
                            repo: repo,
                            token: ''
                        };
                    }
                }
            }
            
            // 저장된 GitHub 설정 불러오기
            var savedConfig = localStorage.getItem('grade3-githubConfig');
            var savedDataUrl = localStorage.getItem('grade3-dataUrl');
            
            var finalConfig = null;
            var configSource = '';
            
            if (savedConfig && savedDataUrl) {
                try {
                    finalConfig = JSON.parse(savedConfig);
                    configSource = '저장된 설정';
                } catch (error) {
                    console.error('저장된 설정 파싱 실패:', error);
                }
            } else if (autoConfig) {
                finalConfig = autoConfig;
                configSource = '자동 감지';
            }
            
            if (finalConfig && finalConfig.username && finalConfig.repo) {
                console.log('설정 사용 (' + configSource + '):', finalConfig);
                
                githubConfig = finalConfig;
                dataUrl = 'https://raw.githubusercontent.com/' + finalConfig.username + '/' + finalConfig.repo + '/main/grade3-data.json';
                
                // localStorage에 저장 (다음에 더 빠르게 로드하기 위해)
                localStorage.setItem('grade3-githubConfig', JSON.stringify(githubConfig));
                localStorage.setItem('grade3-dataUrl', dataUrl);
                
                console.log('데이터 로드 시작...');
                // 약간의 지연 후 데이터 로드 시도
                setTimeout(function() {
                    loadDataFromGitHub();
                }, 1000);
                
            } else {
                console.log('설정을 찾을 수 없음');
                updateDataStatus('GitHub 설정이 필요합니다. 관리자 탭에서 설정해주세요.');
            }
            
            updateStudentTab();
        };


        
    </script>
</body>
</html>
